<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Is Freedom Better? | Do Freer Countries Have Better Quality of Life?</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Do countries with freer markets have happier, healthier, wealthier citizens? We analyzed 150+ countries. The answer: yes, and the data is clear.">
    <meta name="keywords" content="economic freedom, quality of life, free market, capitalism, happiness index, GDP per capita, life expectancy, country comparison, economic data">
    <meta name="author" content="Is Freedom Better">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://isfreedombetter.com/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://isfreedombetter.com/">
    <meta property="og:title" content="Is Freedom Better? | Data-Driven Analysis">
    <meta property="og:description" content="Do countries with freer markets have better quality of life? We analyzed 150+ countries. The answer is yes.">
    <meta property="og:image" content="https://isfreedombetter.com/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:site_name" content="Is Freedom Better">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://isfreedombetter.com/">
    <meta name="twitter:title" content="Is Freedom Better? | Data-Driven Analysis">
    <meta name="twitter:description" content="Do countries with freer markets have better quality of life? We analyzed 150+ countries. The answer is yes.">
    <meta name="twitter:image" content="https://isfreedombetter.com/og-image.jpg">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Is Freedom Better",
        "url": "https://isfreedombetter.com",
        "description": "Data-driven analysis of economic freedom versus quality of life across countries",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://isfreedombetter.com/?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Dataset",
        "name": "Economic Freedom vs Quality of Life Dataset",
        "description": "Comprehensive dataset comparing economic freedom indices with quality of life metrics across 150+ countries",
        "url": "https://isfreedombetter.com/data.json",
        "license": "https://creativecommons.org/licenses/by/4.0/",
        "creator": {
            "@type": "Organization",
            "name": "Is Freedom Better"
        },
        "distribution": {
            "@type": "DataDownload",
            "encodingFormat": "application/json",
            "contentUrl": "https://isfreedombetter.com/data.json"
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

    <!-- PostHog Analytics -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog && window.posthog.__loaded)||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init ts ns yi rs os Qr es capture Hi calculateEventProperties hs register register_once register_for_session unregister unregister_for_session fs getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey cancelPendingSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException startExceptionAutocapture stopExceptionAutocapture loadToolbar get_property getSessionProperty vs us createPersonProfile cs Yr ps opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing ls debug O ds getPageViewId captureTraceFeedback captureTraceMetric Vr".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('phc_jK5vMFxp1Mki4dE22LE0Br5awvNoUsoLTbxO5cTZlAj', {
            api_host: 'https://us.i.posthog.com',
            defaults: '2025-11-30',
            person_profiles: 'identified_only'
        })
    </script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #d97706;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        header {
            text-align: center;
            padding: 40px 20px 15px;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 30px;
            position: relative;
        }

        nav a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 8px 0;
            font-size: 0.95rem;
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        nav a:hover {
            color: white;
        }

        nav a.active {
            color: white;
        }

        .nav-indicator {
            position: absolute;
            bottom: 0;
            height: 2px;
            background: white;
            transition: left 0.3s ease, width 0.3s ease;
            pointer-events: none;
        }

        /* Sliding panels */
        .panels-wrapper {
            overflow: hidden;
            position: relative;
        }

        .panels-container {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 400%;
        }

        .panel {
            width: 25%;
            flex-shrink: 0;
            min-height: calc(100vh - 200px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .card h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .card .value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .card .value.positive { color: var(--success); }
        .card .value.negative { color: var(--danger); }
        .card .value.neutral { color: var(--warning); }

        .card .label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .verdict-card {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px;
        }

        .verdict-card .verdict {
            font-size: 1.3rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        /* Correlations table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .correlations-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            min-width: 600px;
        }

        .correlations-table th,
        .correlations-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .correlations-table th {
            background: #f1f5f9;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mobile-note { display: none; }

        .correlations-table tr:hover {
            background: #f8fafc;
        }

        .correlation-value {
            font-weight: 600;
            font-family: monospace;
            font-size: 1rem;
            display: inline-block;
            width: 70px;
            text-align: right;
        }

        .correlation-bar-container {
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .correlation-bar {
            width: 120px;
            height: 12px;
            background: #e2e8f0;
            border-radius: 4px;
            position: relative;
            margin: 0 5px;
        }

        .correlation-bar-center {
            position: absolute;
            left: 50%;
            top: -2px;
            bottom: -2px;
            width: 2px;
            background: #94a3b8;
            transform: translateX(-50%);
        }

        .correlation-bar-fill {
            position: absolute;
            height: 100%;
        }

        .significance {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .significance.high { background: #dcfce7; color: #166534; }
        .significance.medium { background: #fef9c3; color: #854d0e; }
        .significance.low { background: #fee2e2; color: #991b1b; }

        .direction-icon {
            font-size: 1.2rem;
            margin-right: 5px;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .chart-container h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .interpretation-box {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .interpretation-box.positive {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #16a34a;
        }

        .interpretation-box.negative {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }

        .chart-selector {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .selector-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selector-row label {
            font-weight: 500;
            white-space: nowrap;
        }

        .chart-selector select {
            padding: 10px 15px;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            min-width: 200px;
        }

        /* Data sources */
        .data-sources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
        }

        .source-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .source-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .source-card h4 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--text);
        }

        .source-card .source-org {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .source-card .source-year {
            display: inline-block;
            background: #e0f2fe;
            color: #0369a1;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .source-card .source-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .source-card a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .source-card a:hover {
            text-decoration: underline;
        }

        .source-card a svg {
            width: 16px;
            height: 16px;
        }

        /* Heatmap */
        .heatmap-table {
            border-collapse: collapse;
            font-size: 0.85rem;
            width: 100%;
            min-width: 700px;
        }

        .heatmap-table th,
        .heatmap-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .heatmap-table th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text);
        }

        .heatmap-table th.row-header {
            text-align: right;
            padding-right: 12px;
            background: #f8fafc;
            white-space: nowrap;
        }

        .heatmap-table td {
            font-weight: 600;
            font-family: monospace;
            transition: transform 0.1s;
        }

        .heatmap-table td:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: relative;
            z-index: 1;
        }

        .caveats {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
        }

        .caveats h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .caveats ul {
            color: #78350f;
            margin-left: 20px;
        }

        /* Raw Data Panel Styles */
        .controls {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .controls label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .controls input[type="text"] {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            width: 250px;
        }

        .controls select {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .download-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .download-btn:hover {
            background: #1d4ed8;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 70vh;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 1200px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: #f1f5f9;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .data-table th:hover {
            background: #e2e8f0;
        }

        .data-table th .sort-icon {
            margin-left: 5px;
            opacity: 0.3;
        }

        .data-table th.sorted .sort-icon {
            opacity: 1;
        }

        .data-table tr {
            transition: background-color 0.2s ease;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .data-table td {
            font-family: monospace;
        }

        .data-table td.country-name {
            font-family: inherit;
            font-weight: 500;
        }

        .data-table td.region {
            font-family: inherit;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Sticky columns for horizontal scrolling */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 5;
            background: #f1f5f9;
        }

        .data-table td:nth-child(1) {
            background: white;
        }

        .data-table tr:hover td:nth-child(1) {
            background: #f8fafc;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            position: sticky;
            left: 50px;
            z-index: 5;
            background: #f1f5f9;
        }

        .data-table td:nth-child(2) {
            background: white;
        }

        .data-table tr:hover td:nth-child(2) {
            background: #f8fafc;
        }

        /* Ensure sticky header cells have higher z-index */
        .data-table th:nth-child(1),
        .data-table th:nth-child(2) {
            z-index: 15;
        }

        /* About Panel Styles */
        .about-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .about-card h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .about-card p {
            margin-bottom: 15px;
        }

        .about-card p:last-child {
            margin-bottom: 0;
        }

        .about-card ul {
            margin: 15px 0 15px 20px;
        }

        .about-card li {
            margin-bottom: 8px;
        }

        .methodology-step {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-content h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .step-content p {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-bottom: 0;
        }

        .disclaimer {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .disclaimer h3 {
            color: #92400e;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .disclaimer p {
            color: #78350f;
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            margin-top: 40px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Comparison section styles */
        .comparison-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .comparison-header {
            display: none;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 1000px) {
            .comparison-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 650px) {
            .comparison-grid { grid-template-columns: 1fr; }
        }

        .comparison-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .comparison-metric {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        .comparison-bar-col {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .comparison-bar-col::before {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 60px;
        }
        .comparison-bar-col[data-label="Economic Freedom"]::before { content: "Freedom"; }
        .comparison-bar-col[data-label="Equality (Gini)"]::before { content: "Equality"; }
        .comparison-winner {
            display: none;
        }

        .comparison-bar-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .comparison-bar-track {
            flex: 1;
            height: 24px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .comparison-bar-fill-green {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            border-radius: 4px;
        }

        .comparison-bar-fill-red {
            height: 100%;
            background: linear-gradient(90deg, #f87171, #dc2626);
            border-radius: 4px;
        }

        .comparison-value {
            font-family: monospace;
            font-weight: 600;
            min-width: 50px;
        }

        .comparison-conclusion {
            margin-top: 20px;
            padding: 16px;
            background: #dcfce7;
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        /* Responsive text visibility */
        .desktop-only { display: inline; }
        .mobile-only { display: none; }

        @media (max-width: 768px) {
            header { padding: 30px 15px; }
            header h1 { font-size: 1.6rem; }
            header p { font-size: 0.95rem; }
            .desktop-only { display: none; }
            .mobile-only { display: inline; }
            .container { padding: 15px; }
            .charts-grid { grid-template-columns: 1fr; }
            .chart-selector { flex-direction: column; align-items: stretch; }
            .selector-row { flex-direction: column; align-items: stretch; gap: 5px; }
            .chart-selector select { min-width: 100%; }
            .chart-wrapper { height: 300px; }
            /* Mobile: Compact data-dense layout */
            .correlations-table { min-width: auto; font-size: 0.8rem; }
            .correlations-table thead { display: none; }
            .correlations-table tbody { display: flex; flex-direction: column; gap: 0; }
            .correlations-table tr {
                display: grid;
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                gap: 6px 12px;
                padding: 12px 14px;
                align-items: center;
                border-bottom: 1px solid var(--border);
                background: var(--card-bg);
            }
            .correlations-table tr:hover { background: #f8fafc; }
            .correlations-table td:first-child {
                display: block;
                grid-column: 1;
                grid-row: 1;
                padding: 0;
                border: none;
            }
            .correlations-table td:first-child strong { font-size: 0.9rem; }
            .correlations-table td:first-child small,
            .correlations-table td:first-child br { display: none; }
            .correlations-table td:nth-child(2) {
                grid-column: 2;
                grid-row: 1 / 3;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                justify-content: center;
                gap: 2px;
                padding: 0;
                border: none;
            }
            .correlation-value { font-size: 1.2rem; font-weight: 700; width: auto; text-align: right; }
            .correlation-bar-container { display: flex; flex-direction: row; align-items: center; margin-left: 0; gap: 4px; }
            .correlation-bar { width: 140px; height: 16px; border-radius: 8px; }
            .correlation-bar-container > span { font-size: 0.6rem; color: var(--text-muted); }
            .correlations-table td:nth-child(3) { display: none; }
            .correlations-table .direction-cell {
                display: block;
                grid-column: 1;
                grid-row: 2;
                padding: 0;
                border: none;
                font-size: 0.7rem;
                text-align: left;
            }
            .correlations-table .direction-cell::after {
                content: " · " attr(data-n);
                color: var(--text-muted);
            }
            .correlations-table .sample-size-cell {
                display: none;
            }
            .direction-icon { font-size: 0.8rem; vertical-align: middle; }
            .mobile-note { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px; }
            .summary-cards { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .card { padding: 16px; }
            .card .value { font-size: 2rem; }
            .verdict-card { grid-column: 1 / -1; }
            .data-sources { grid-template-columns: 1fr; }
            .source-card { padding: 15px; }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .controls input[type="text"] {
                width: 100%;
            }
            .download-btn {
                margin-left: 0;
                justify-content: center;
            }
            .stats { gap: 10px; }
            .stat-card { padding: 12px 15px; flex: 1; min-width: 0; }
            .stat-card .value { font-size: 1.2rem; }
            .about-card { padding: 20px; }
            .methodology-step { flex-direction: column; gap: 10px; }
            .section h2 { font-size: 1.25rem; }
        }

        @media (max-width: 480px) {
            header h1 { font-size: 1.4rem; }
            nav { gap: 16px; margin-top: 20px; }
            nav a { font-size: 0.85rem; padding: 6px 0; }
            .summary-cards { grid-template-columns: 1fr; }
            .card .value { font-size: 1.8rem; }
            .correlations-table tr { padding: 10px 12px; }
            .correlations-table td:first-child strong { font-size: 0.85rem; }
            .correlation-value { font-size: 1rem; width: auto; }
            .correlation-bar { width: 120px; height: 16px; }
            .correlations-table td:nth-child(4) { font-size: 0.65rem; }
            .correlations-table td:nth-child(5) { font-size: 0.65rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Is Freedom Better?</h1>
        <p style="font-size: 1.1rem; opacity: 0.9; margin-top: 10px;">Do countries with freer markets have better quality of life?</p>
        <nav>
            <a onclick="navigateTo(0)" class="active" data-panel="0">Dashboard</a>
            <a onclick="navigateTo(1)" data-panel="1">Raw Data</a>
            <a onclick="navigateTo(2)" data-panel="2">About</a>
            <a onclick="navigateTo(3)" data-panel="3">Contact</a>
            <span class="nav-indicator"></span>
        </nav>
    </header>

    <div class="panels-wrapper">
        <div class="panels-container" id="panelsContainer">
            <!-- Dashboard Panel -->
            <div class="panel" id="dashboardPanel">
                <div class="container">
                    <div id="dashboardContent" class="loading">Loading analysis data...</div>
                </div>
            </div>

            <!-- Raw Data Panel -->
            <div class="panel" id="dataPanel">
                <div class="container">
                    <div id="dataContent" class="loading">Loading data...</div>
                </div>
            </div>

            <!-- About Panel -->
            <div class="panel" id="aboutPanel">
                <div class="container">
                    <div class="about-card">
                        <h2>Purpose</h2>
                        <p>Is freedom better? That's the question this project tries to answer using data. We examine the statistical relationship between economic freedom and quality-of-life indicators across 150+ countries.</p>
                        <p>Economic freedom, as measured by the Heritage Foundation's Index of Economic Freedom, encompasses factors like property rights, government integrity, tax burden, business freedom, and trade freedom.</p>
                    </div>

                    <div class="about-card">
                        <h2>On Correlation and Causation</h2>
                        <p><strong>Correlation does not imply causation</strong> — this is a fundamental principle of statistics. However, when studying complex societal phenomena like the relationship between economic systems and quality of life, establishing direct causation is practically impossible.</p>
                        <p>Unlike laboratory experiments where we can isolate variables and test hypotheses in controlled conditions, we cannot simply "remove" geography, history, culture, natural resources, or political systems from the equation to see how economies would behave differently. We cannot run randomized controlled trials on entire nations.</p>
                        <p>This means that <strong>correlation analysis, while imperfect, represents the best available evidence</strong> we can gather on this subject. The consistent, statistically significant correlations across multiple independent metrics and data sources provide a compelling picture — not proof, but the strongest empirical foundation currently available.</p>
                        <p>Until someone develops a better methodology to study these complex systems, this data-driven approach offers the clearest window into how economic freedom relates to human flourishing.</p>
                    </div>

                    <div class="about-card">
                        <h2>Methodology</h2>
                        <div class="methodology-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h3>Data Collection</h3>
                                <p>Data is gathered from reputable international organizations including the Heritage Foundation, World Bank, UN, Transparency International, and others.</p>
                            </div>
                        </div>
                        <div class="methodology-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h3>Country Matching</h3>
                                <p>Countries are matched across datasets by name. Only countries with valid data in both the Economic Freedom Index and the comparison metric are included in each correlation.</p>
                            </div>
                        </div>
                        <div class="methodology-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h3>Correlation Analysis</h3>
                                <p>Pearson correlation coefficients are calculated to measure the linear relationship between economic freedom and each quality-of-life indicator.</p>
                            </div>
                        </div>
                        <div class="methodology-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h3>Statistical Significance</h3>
                                <p>P-values are calculated to determine if correlations are statistically significant (p < 0.05), meaning they're unlikely to occur by chance.</p>
                            </div>
                        </div>
                    </div>

                    <div class="about-card">
                        <h2>Data Sources</h2>
                        <ul>
                            <li><strong>Economic Freedom:</strong> <a href="https://www.heritage.org/index/" target="_blank" rel="noopener">Heritage Foundation Index of Economic Freedom</a></li>
                            <li><strong>GDP & Health:</strong> <a href="https://data.worldbank.org/indicator" target="_blank" rel="noopener">World Bank Development Indicators</a></li>
                            <li><strong>Corruption:</strong> <a href="https://www.transparency.org/en/cpi" target="_blank" rel="noopener">Transparency International Corruption Perceptions Index</a></li>
                            <li><strong>Human Development:</strong> <a href="https://hdr.undp.org/data-center/human-development-index" target="_blank" rel="noopener">UN Human Development Index</a></li>
                            <li><strong>Happiness:</strong> <a href="https://worldhappiness.report/" target="_blank" rel="noopener">World Happiness Report</a></li>
                            <li><strong>Democracy:</strong> <a href="https://www.eiu.com/n/campaigns/democracy-index-2024/" target="_blank" rel="noopener">Economist Intelligence Unit Democracy Index</a></li>
                            <li><strong>Social Mobility:</strong> <a href="https://www.weforum.org/publications/global-social-mobility-index-2020-why-economies-benefit-from-fixing-inequality/" target="_blank" rel="noopener">World Economic Forum Global Social Mobility Index</a></li>
                            <li><strong>Purchasing Power:</strong> <a href="https://www.numbeo.com/cost-of-living/" target="_blank" rel="noopener">Numbeo Cost of Living Index</a></li>
                            <li><strong>Pollution:</strong> <a href="https://www.numbeo.com/pollution/" target="_blank" rel="noopener">Numbeo Pollution Index</a></li>
                            <li><strong>Inequality:</strong> <a href="https://data.worldbank.org/indicator/SI.POV.GINI" target="_blank" rel="noopener">World Bank Gini Index</a></li>
                        </ul>
                    </div>

                    <div class="about-card">
                        <h2>Interpreting Correlations</h2>
                        <p>A <strong>correlation coefficient (r)</strong> measures the strength and direction of a linear relationship between two variables:</p>
                        <ul>
                            <li><strong>r = 1.0:</strong> Perfect positive correlation</li>
                            <li><strong>r = 0.7 to 0.9:</strong> Strong positive correlation</li>
                            <li><strong>r = 0.4 to 0.6:</strong> Moderate positive correlation</li>
                            <li><strong>r = 0.1 to 0.3:</strong> Weak positive correlation</li>
                            <li><strong>r = 0:</strong> No correlation</li>
                            <li><strong>r = -1.0:</strong> Perfect negative correlation</li>
                        </ul>
                        <p><strong>Context matters:</strong> In social sciences, 0.5 is considered a large effect size (Cohen, 1988) — roughly 75% of published correlations fall below that threshold.</p>
                        <p>For metrics where lower is better (like infant mortality), the sign is flipped in the "effective correlation" to make all positive correlations represent better outcomes.</p>
                    </div>
                </div>
            </div>

            <!-- Contact Panel -->
            <div class="panel" id="contactPanel">
                <div class="container">
                    <div class="about-card">
                        <h2>Get in Touch</h2>
                        <p>Found a bug? Have a suggestion? Think we got something wrong? We'd love to hear from you. All feedback helps make this analysis better.</p>
                        <form id="contactForm" onsubmit="sendContactMessage(event)" style="margin-top: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label for="contactName" style="display: block; margin-bottom: 5px; font-weight: 500;">Name (optional)</label>
                                <input type="text" id="contactName" placeholder="Your name" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="contactEmail" style="display: block; margin-bottom: 5px; font-weight: 500;">Email (optional)</label>
                                <input type="email" id="contactEmail" placeholder="your@email.com" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="contactMessage" style="display: block; margin-bottom: 5px; font-weight: 500;">Message *</label>
                                <textarea id="contactMessage" placeholder="What's on your mind?" required rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                            </div>
                            <button type="submit" id="contactSubmit" style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 500;">Send Message</button>
                            <div id="contactStatus" style="margin-top: 15px;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p id="lastUpdated"></p>
        <p>Data is automatically refreshed weekly via GitHub Actions.</p>
    </footer>

    <script>
        let currentPanel = 0;
        let allData = [];
        let sortColumn = 'economic_freedom';
        let sortDirection = 'desc';
        let userCountry = null;
        let isUserCountry = false;

        // Detect user's country via IP geolocation
        async function detectUserCountry() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                if (data.country_name) {
                    userCountry = data.country_name;
                    // Set the country selector if it exists and country is in our data
                    const countrySelect = document.getElementById('countrySelect');
                    if (countrySelect) {
                        const option = Array.from(countrySelect.options).find(
                            opt => opt.value.toLowerCase() === userCountry.toLowerCase()
                        );
                        if (option) {
                            countrySelect.value = option.value;
                            isUserCountry = true;
                            updateChart();
                        }
                    }
                }
            } catch (error) {
                console.log('Could not detect country:', error);
            }
        }

        // Navigation
        function navigateTo(panelIndex) {
            currentPanel = panelIndex;
            const container = document.getElementById('panelsContainer');
            container.style.transform = `translateX(-${panelIndex * 25}%)`;

            // Update nav active state and move indicator
            const indicator = document.querySelector('.nav-indicator');
            document.querySelectorAll('nav a').forEach(a => {
                a.classList.remove('active');
                if (parseInt(a.dataset.panel) === panelIndex) {
                    a.classList.add('active');
                    // Move indicator to this element
                    indicator.style.left = a.offsetLeft + 'px';
                    indicator.style.width = a.offsetWidth + 'px';
                }
            });

            // Update URL hash (without triggering hashchange)
            const hashes = ['', '#data', '#about', '#contact'];
            const pageNames = ['Dashboard', 'Raw Data', 'About', 'Contact'];
            history.replaceState(null, null, hashes[panelIndex] || window.location.pathname);

            // Track page view in PostHog
            if (window.posthog) {
                posthog.capture('$pageview', { page: pageNames[panelIndex] });
            }
        }

        // Fetch and render data
        async function loadData() {
            try {
                const response = await fetch('data.json');
                const data = await response.json();
                window.analysisData = data;
                allData = data.countries;
                renderDashboard(data);
                renderDataPanel(data);
                // Detect user country after charts are initialized
                detectUserCountry();
            } catch (error) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="card" style="text-align: center; color: var(--danger);">
                        <h3>Error Loading Data</h3>
                        <p>Could not load analysis data. Please try again later.</p>
                        <p style="font-size: 0.8rem; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderDashboard(data) {
            const content = document.getElementById('dashboardContent');
            content.classList.remove('loading');

            // Update last updated
            const date = new Date(data.metadata.generated_at);
            document.getElementById('lastUpdated').textContent =
                `Last updated: ${formatDatePretty(date)}`;

            content.innerHTML = `
                <!-- Quick Intro -->
                <div style="text-align: center; margin-bottom: 35px; max-width: 700px; margin-left: auto; margin-right: auto;">
                    <p style="color: var(--text-muted); font-size: 1rem; margin-bottom: 15px;">
                        <strong>Economic freedom</strong> = property rights, low corruption, ease of doing business, free trade.<br>
                        We compared 150+ countries to see if freer economies correlate with better lives.
                    </p>
                    <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 10px; padding: 16px 20px; border-left: 4px solid var(--success);">
                        <p style="margin: 0; font-size: 1.05rem;"><strong>The short answer:</strong> Yes. Freer countries consistently score higher on happiness, health, wealth, and opportunity.</p>
                    </div>
                </div>

                <!-- Correlations Table -->
                <div class="section">
                    <h2>The Evidence</h2>
                    <p class="correlation-intro" style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6;">
                        <span class="desktop-only">Each row shows the link between economic freedom and a quality-of-life metric. Higher numbers = stronger relationship. Anything above <strong>0.5</strong> is considered strong in social science.</span>
                        <span class="mobile-only">Higher numbers = stronger link. Above <strong>0.5</strong> is strong.</span>
                    </p>
                    <div class="mobile-note">All correlations statistically significant (p < 0.001)</div>
                    <div class="table-responsive">
                        <table class="correlations-table">
                            <thead>
                                <tr>
                                    <th>Index</th>
                                    <th>Correlation (r)</th>
                                    <th>Significance</th>
                                    <th>Direction</th>
                                    <th>Sample Size</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.correlations.map(c => renderCorrelationRow(c)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Interactive Charts -->
                <div class="section">
                    <h2>Interactive Scatter Plots</h2>
                    <div class="chart-selector">
                        <div class="selector-row">
                            <label for="indexSelect">Select Index: </label>
                            <select id="indexSelect" onchange="updateChart()">
                                ${data.correlations.map(c =>
                                    `<option value="${c.id}">${c.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="selector-row">
                            <label for="countrySelect">Highlight Country: </label>
                            <select id="countrySelect" onchange="updateChart()">
                                <option value="">None</option>
                                ${data.countries
                                    .filter(c => c.economic_freedom)
                                    .sort((a, b) => a.name.localeCompare(b.name))
                                    .map(c => `<option value="${c.name}">${c.name}</option>`)
                                    .join('')}
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="scatterChart"></canvas>
                        </div>
                        <div id="chartInterpretation" class="interpretation-box positive"></div>
                    </div>
                </div>

                <!-- Economic Freedom vs Equality Comparison -->
                <div class="section">
                    <h2>Freedom vs Equality: Which Matters More?</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Free markets or reducing inequality — which correlates better with good outcomes? Longer bars = stronger link.</p>
                    <div id="comparisonSection"></div>
                </div>

                <!-- Data Sources -->
                <div class="section">
                    <h2>Data Sources</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">All from reputable international organizations. Click to verify.</p>
                    <div class="data-sources">
                        ${renderDataSources()}
                    </div>
                    <div class="caveats">
                        <h3>Important Caveats</h3>
                        <ul>
                            <li><strong>Correlation does not imply causation.</strong> These relationships do not prove that economic freedom causes better outcomes.</li>
                            <li>Many confounding variables exist, including historical, geographical, and cultural factors.</li>
                            <li>Economic freedom indices have methodological limitations and biases.</li>
                            <li>Data availability and quality varies significantly by country.</li>
                        </ul>
                    </div>
                </div>

                            `;

            // Initialize charts
            initScatterChart();
            renderComparison();
        }

        function renderDataPanel(data) {
            const content = document.getElementById('dataContent');
            content.classList.remove('loading');

            const lastUpdated = formatDatePretty(new Date(data.metadata.generated_at));

            content.innerHTML = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="label">Countries</div>
                        <div class="value">${data.countries.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Data Points</div>
                        <div class="value">${data.countries.length * 10}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Last Updated</div>
                        <div class="value" style="font-size: 1rem;">${lastUpdated}</div>
                    </div>
                </div>

                <div class="controls">
                    <div>
                        <label for="search">Search Country: </label>
                        <input type="text" id="search" placeholder="Type country name..." oninput="filterTable()">
                    </div>
                    <div>
                        <label for="regionFilter">Filter by Region: </label>
                        <select id="regionFilter" onchange="filterTable()">
                            <option value="">All Regions</option>
                            ${getRegions().map(r => `<option value="${r}">${r}</option>`).join('')}
                        </select>
                    </div>
                    <button class="download-btn" onclick="downloadCSV()">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download CSV
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-scroll">
                        <table class="data-table" id="dataTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th onclick="sortTable('name')">Country <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('region')">Region <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('economic_freedom')" class="sorted">Econ Freedom <span class="sort-icon">↓</span></th>
                                    <th onclick="sortTable('gdp_per_capita')">GDP/Capita <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('life_expectancy')">Life Exp. <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('infant_mortality')">Infant Mort. <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('corruption_score')">Anti-Corrupt. <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('hdi')">HDI <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('happiness_score')">Happiness <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('democracy_score')">Democracy <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('social_mobility_score')">Social Mob. <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('purchasing_power_index')">Purch. Power <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('pollution_index')">Pollution <span class="sort-icon">↕</span></th>
                                    <th onclick="sortTable('gini_index')">Gini <span class="sort-icon">↕</span></th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            renderTable();
        }

        function getRegions() {
            const regions = [...new Set(allData.map(c => c.region).filter(r => r))];
            return regions.sort();
        }

        function renderTable() {
            const search = document.getElementById('search')?.value.toLowerCase() || '';
            const region = document.getElementById('regionFilter')?.value || '';

            let filtered = allData.filter(c => {
                const matchesSearch = c.name.toLowerCase().includes(search);
                const matchesRegion = !region || c.region === region;
                return matchesSearch && matchesRegion;
            });

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                if (aVal === null || aVal === undefined) aVal = sortDirection === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined) bVal = sortDirection === 'asc' ? Infinity : -Infinity;

                if (sortColumn === 'name' || sortColumn === 'region') {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }

                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });

            const tbody = document.getElementById('tableBody');
            if (!tbody) return;

            tbody.innerHTML = filtered.map((c, index) => `
                <tr>
                    <td style="color: var(--text-muted); font-weight: 500;">${index + 1}</td>
                    <td class="country-name">${c.name}</td>
                    <td class="region">${c.region || '-'}</td>
                    <td>${formatLinkedValue(c.name, 'economic_freedom', c.economic_freedom, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'gdp_per_capita', c.gdp_per_capita, 0, true)}</td>
                    <td>${formatLinkedValue(c.name, 'life_expectancy', c.life_expectancy, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'infant_mortality', c.infant_mortality, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'corruption_score', c.corruption_score, 0)}</td>
                    <td>${formatLinkedValue(c.name, 'hdi', c.hdi, 3)}</td>
                    <td>${formatLinkedValue(c.name, 'happiness_score', c.happiness_score, 2)}</td>
                    <td>${formatLinkedValue(c.name, 'democracy_score', c.democracy_score, 2)}</td>
                    <td>${formatLinkedValue(c.name, 'social_mobility_score', c.social_mobility_score, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'purchasing_power_index', c.purchasing_power_index, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'pollution_index', c.pollution_index, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'gini_index', c.gini_index, 1)}</td>
                </tr>
            `).join('');

            // Update header sort icons
            document.querySelectorAll('.data-table th').forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.textContent = '↕';
            });
            const sortedTh = document.querySelector(`.data-table th[onclick="sortTable('${sortColumn}')"]`);
            if (sortedTh) {
                sortedTh.classList.add('sorted');
                sortedTh.querySelector('.sort-icon').textContent = sortDirection === 'asc' ? '↑' : '↓';
            }
        }

        function formatValue(val, decimals, isCurrency = false) {
            if (val === null || val === undefined) {
                return '<span style="color: var(--text-muted); font-style: italic;">N/A</span>';
            }
            let formatted = decimals === 0 ? Math.round(val).toLocaleString() : val.toFixed(decimals);
            if (isCurrency) {
                formatted = '$' + formatted;
            }
            return formatted;
        }

        function formatDatePretty(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();

            // Add ordinal suffix
            let suffix = 'th';
            if (day === 1 || day === 21 || day === 31) suffix = 'st';
            else if (day === 2 || day === 22) suffix = 'nd';
            else if (day === 3 || day === 23) suffix = 'rd';

            return `${month} ${day}${suffix} ${year}`;
        }

        // ISO country codes for external links
        const countryISO = {
            'Afghanistan': 'AF', 'Albania': 'AL', 'Algeria': 'DZ', 'Angola': 'AO', 'Argentina': 'AR',
            'Armenia': 'AM', 'Australia': 'AU', 'Austria': 'AT', 'Azerbaijan': 'AZ', 'Bahrain': 'BH',
            'Bangladesh': 'BD', 'Belarus': 'BY', 'Belgium': 'BE', 'Belize': 'BZ', 'Benin': 'BJ',
            'Bhutan': 'BT', 'Bolivia': 'BO', 'Bosnia and Herzegovina': 'BA', 'Botswana': 'BW', 'Brazil': 'BR',
            'Brunei': 'BN', 'Bulgaria': 'BG', 'Burkina Faso': 'BF', 'Burundi': 'BI', 'Cambodia': 'KH',
            'Cameroon': 'CM', 'Canada': 'CA', 'Cape Verde': 'CV', 'Central African Republic': 'CF', 'Chad': 'TD',
            'Chile': 'CL', 'China': 'CN', 'Colombia': 'CO', 'Comoros': 'KM', 'Costa Rica': 'CR',
            'Croatia': 'HR', 'Cuba': 'CU', 'Cyprus': 'CY', 'Czech Republic': 'CZ', 'DR Congo': 'CD',
            'Denmark': 'DK', 'Djibouti': 'DJ', 'Dominican Republic': 'DO', 'Ecuador': 'EC', 'Egypt': 'EG',
            'El Salvador': 'SV', 'Equatorial Guinea': 'GQ', 'Estonia': 'EE', 'Ethiopia': 'ET', 'Fiji': 'FJ',
            'Finland': 'FI', 'France': 'FR', 'Gabon': 'GA', 'Gambia': 'GM', 'Georgia': 'GE',
            'Germany': 'DE', 'Ghana': 'GH', 'Greece': 'GR', 'Guatemala': 'GT', 'Guinea': 'GN',
            'Guyana': 'GY', 'Haiti': 'HT', 'Honduras': 'HN', 'Hong Kong': 'HK', 'Hungary': 'HU',
            'Iceland': 'IS', 'India': 'IN', 'Indonesia': 'ID', 'Iran': 'IR', 'Iraq': 'IQ',
            'Ireland': 'IE', 'Israel': 'IL', 'Italy': 'IT', 'Ivory Coast': 'CI', 'Jamaica': 'JM',
            'Japan': 'JP', 'Jordan': 'JO', 'Kazakhstan': 'KZ', 'Kenya': 'KE', 'Kuwait': 'KW',
            'Kyrgyzstan': 'KG', 'Laos': 'LA', 'Latvia': 'LV', 'Lebanon': 'LB', 'Lesotho': 'LS',
            'Liberia': 'LR', 'Libya': 'LY', 'Lithuania': 'LT', 'Luxembourg': 'LU', 'Madagascar': 'MG',
            'Malawi': 'MW', 'Malaysia': 'MY', 'Maldives': 'MV', 'Mali': 'ML', 'Malta': 'MT',
            'Mauritania': 'MR', 'Mauritius': 'MU', 'Mexico': 'MX', 'Moldova': 'MD', 'Mongolia': 'MN',
            'Montenegro': 'ME', 'Morocco': 'MA', 'Mozambique': 'MZ', 'Burma': 'MM', 'Namibia': 'NA',
            'Nepal': 'NP', 'Netherlands': 'NL', 'New Zealand': 'NZ', 'Nicaragua': 'NI', 'Niger': 'NE',
            'Nigeria': 'NG', 'North Korea': 'KP', 'North Macedonia': 'MK', 'Norway': 'NO', 'Oman': 'OM',
            'Pakistan': 'PK', 'Panama': 'PA', 'Papua New Guinea': 'PG', 'Paraguay': 'PY', 'Peru': 'PE',
            'Philippines': 'PH', 'Poland': 'PL', 'Portugal': 'PT', 'Qatar': 'QA', 'Romania': 'RO',
            'Russia': 'RU', 'Rwanda': 'RW', 'Saudi Arabia': 'SA', 'Senegal': 'SN', 'Serbia': 'RS',
            'Sierra Leone': 'SL', 'Singapore': 'SG', 'Slovakia': 'SK', 'Slovenia': 'SI', 'South Africa': 'ZA',
            'South Korea': 'KR', 'Spain': 'ES', 'Sri Lanka': 'LK', 'Sudan': 'SD', 'Suriname': 'SR',
            'Sweden': 'SE', 'Switzerland': 'CH', 'Syria': 'SY', 'Taiwan': 'TW', 'Tajikistan': 'TJ',
            'Tanzania': 'TZ', 'Thailand': 'TH', 'Togo': 'TG', 'Trinidad and Tobago': 'TT', 'Tunisia': 'TN',
            'Turkey': 'TR', 'Turkmenistan': 'TM', 'Uganda': 'UG', 'Ukraine': 'UA', 'UAE': 'AE',
            'United Kingdom': 'GB', 'United States': 'US', 'Uruguay': 'UY', 'Uzbekistan': 'UZ',
            'Venezuela': 'VE', 'Vietnam': 'VN', 'Yemen': 'YE', 'Zambia': 'ZM', 'Zimbabwe': 'ZW',
            'Kosovo': 'XK', 'Macedonia': 'MK', 'Congo': 'CG'
        };

        function getDataUrl(country, field) {
            const iso = countryISO[country] || '';
            const iso2to3 = {
                'AF': 'AFG', 'AL': 'ALB', 'DZ': 'DZA', 'AD': 'AND', 'AO': 'AGO', 'AG': 'ATG', 'AR': 'ARG', 'AM': 'ARM', 'AU': 'AUS', 'AT': 'AUT',
                'AZ': 'AZE', 'BS': 'BHS', 'BH': 'BHR', 'BD': 'BGD', 'BB': 'BRB', 'BY': 'BLR', 'BE': 'BEL', 'BZ': 'BLZ', 'BJ': 'BEN', 'BT': 'BTN',
                'BO': 'BOL', 'BA': 'BIH', 'BW': 'BWA', 'BR': 'BRA', 'BN': 'BRN', 'BG': 'BGR', 'BF': 'BFA', 'BI': 'BDI', 'KH': 'KHM', 'CM': 'CMR',
                'CA': 'CAN', 'CV': 'CPV', 'CF': 'CAF', 'TD': 'TCD', 'CL': 'CHL', 'CN': 'CHN', 'CO': 'COL', 'KM': 'COM', 'CG': 'COG', 'CD': 'COD',
                'CR': 'CRI', 'CI': 'CIV', 'HR': 'HRV', 'CU': 'CUB', 'CY': 'CYP', 'CZ': 'CZE', 'DK': 'DNK', 'DJ': 'DJI', 'DM': 'DMA', 'DO': 'DOM',
                'EC': 'ECU', 'EG': 'EGY', 'SV': 'SLV', 'GQ': 'GNQ', 'ER': 'ERI', 'EE': 'EST', 'SZ': 'SWZ', 'ET': 'ETH', 'FJ': 'FJI', 'FI': 'FIN',
                'FR': 'FRA', 'GA': 'GAB', 'GM': 'GMB', 'GE': 'GEO', 'DE': 'DEU', 'GH': 'GHA', 'GR': 'GRC', 'GD': 'GRD', 'GT': 'GTM', 'GN': 'GIN',
                'GW': 'GNB', 'GY': 'GUY', 'HT': 'HTI', 'HN': 'HND', 'HK': 'HKG', 'HU': 'HUN', 'IS': 'ISL', 'IN': 'IND', 'ID': 'IDN', 'IR': 'IRN',
                'IQ': 'IRQ', 'IE': 'IRL', 'IL': 'ISR', 'IT': 'ITA', 'JM': 'JAM', 'JP': 'JPN', 'JO': 'JOR', 'KZ': 'KAZ', 'KE': 'KEN', 'KI': 'KIR',
                'KP': 'PRK', 'KR': 'KOR', 'KW': 'KWT', 'KG': 'KGZ', 'LA': 'LAO', 'LV': 'LVA', 'LB': 'LBN', 'LS': 'LSO', 'LR': 'LBR', 'LY': 'LBY',
                'LI': 'LIE', 'LT': 'LTU', 'LU': 'LUX', 'MG': 'MDG', 'MW': 'MWI', 'MY': 'MYS', 'MV': 'MDV', 'ML': 'MLI', 'MT': 'MLT', 'MH': 'MHL',
                'MR': 'MRT', 'MU': 'MUS', 'MX': 'MEX', 'FM': 'FSM', 'MD': 'MDA', 'MC': 'MCO', 'MN': 'MNG', 'ME': 'MNE', 'MA': 'MAR', 'MZ': 'MOZ',
                'MM': 'MMR', 'NA': 'NAM', 'NR': 'NRU', 'NP': 'NPL', 'NL': 'NLD', 'NZ': 'NZL', 'NI': 'NIC', 'NE': 'NER', 'NG': 'NGA', 'MK': 'MKD',
                'NO': 'NOR', 'OM': 'OMN', 'PK': 'PAK', 'PW': 'PLW', 'PA': 'PAN', 'PG': 'PNG', 'PY': 'PRY', 'PE': 'PER', 'PH': 'PHL', 'PL': 'POL',
                'PT': 'PRT', 'QA': 'QAT', 'RO': 'ROU', 'RU': 'RUS', 'RW': 'RWA', 'KN': 'KNA', 'LC': 'LCA', 'VC': 'VCT', 'WS': 'WSM', 'SM': 'SMR',
                'ST': 'STP', 'SA': 'SAU', 'SN': 'SEN', 'RS': 'SRB', 'SC': 'SYC', 'SL': 'SLE', 'SG': 'SGP', 'SK': 'SVK', 'SI': 'SVN', 'SB': 'SLB',
                'SO': 'SOM', 'ZA': 'ZAF', 'SS': 'SSD', 'ES': 'ESP', 'LK': 'LKA', 'SD': 'SDN', 'SR': 'SUR', 'SE': 'SWE', 'CH': 'CHE', 'SY': 'SYR',
                'TW': 'TWN', 'TJ': 'TJK', 'TZ': 'TZA', 'TH': 'THA', 'TL': 'TLS', 'TG': 'TGO', 'TO': 'TON', 'TT': 'TTO', 'TN': 'TUN', 'TR': 'TUR',
                'TM': 'TKM', 'TV': 'TUV', 'UG': 'UGA', 'UA': 'UKR', 'AE': 'ARE', 'GB': 'GBR', 'US': 'USA', 'UY': 'URY', 'UZ': 'UZB', 'VU': 'VUT',
                'VE': 'VEN', 'VN': 'VNM', 'YE': 'YEM', 'ZM': 'ZMB', 'ZW': 'ZWE', 'XK': 'XKX'
            };
            const iso3 = iso2to3[iso] || iso;
            const countrySlug = country.toLowerCase().replace(/\s+/g, '-');

            const urls = {
                'economic_freedom': `https://www.heritage.org/index/country/${countrySlug}`,
                'gdp_per_capita': `https://data.worldbank.org/indicator/NY.GDP.PCAP.CD?locations=${iso}`,
                'life_expectancy': `https://data.worldbank.org/indicator/SP.DYN.LE00.IN?locations=${iso}`,
                'infant_mortality': `https://data.worldbank.org/indicator/SP.DYN.IMRT.IN?locations=${iso}`,
                'corruption_score': `https://www.transparency.org/en/cpi/2023/index/${iso3.toLowerCase()}`,
                'hdi': `https://hdr.undp.org/data-center/country-insights#/ranks`,
                'happiness_score': `https://ourworldindata.org/grapher/happiness-cantril-ladder?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`,
                'democracy_score': `https://ourworldindata.org/grapher/democracy-index-eiu?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`,
                'social_mobility_score': `https://worldpopulationreview.com/country-rankings/social-mobility-by-country`,
                'purchasing_power_index': `https://www.numbeo.com/cost-of-living/rankings_by_country.jsp?title=2025`,
                'pollution_index': `https://www.numbeo.com/pollution/rankings_by_country.jsp?title=2025`,
                'gini_index': `https://data.worldbank.org/indicator/SI.POV.GINI?locations=${iso}`
            };
            return urls[field] || '#';
        }

        function formatLinkedValue(country, field, val, decimals, isCurrency = false) {
            if (val === null || val === undefined) {
                return '<span style="color: var(--text-muted); font-style: italic;">N/A</span>';
            }
            let formatted = decimals === 0 ? Math.round(val).toLocaleString() : val.toFixed(decimals);
            if (isCurrency) {
                formatted = '$' + formatted;
            }
            const url = getDataUrl(country, field);
            return `<a href="${url}" target="_blank" rel="noopener" style="color: inherit; text-decoration: none; border-bottom: 1px dotted var(--text-muted);" title="View source data">${formatted}</a>`;
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            renderTable();
        }

        function filterTable() {
            renderTable();
        }

        function downloadCSV() {
            const headers = ['Country', 'Region', 'Economic Freedom', 'GDP per Capita', 'Life Expectancy',
                           'Infant Mortality', 'Anti-Corruption', 'HDI', 'Happiness', 'Democracy', 'Social Mobility', 'Purchasing Power', 'Pollution', 'Gini Index'];

            const rows = allData.map(c => [
                c.name,
                c.region || '',
                c.economic_freedom ?? '',
                c.gdp_per_capita ?? '',
                c.life_expectancy ?? '',
                c.infant_mortality ?? '',
                c.corruption_score ?? '',
                c.hdi ?? '',
                c.happiness_score ?? '',
                c.democracy_score ?? '',
                c.social_mobility_score ?? '',
                c.purchasing_power_index ?? '',
                c.pollution_index ?? '',
                c.gini_index ?? ''
            ]);

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'economic_freedom_data.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function getVerdictText(summary) {
            if (summary.verdict === 'supports') {
                return `The data <strong style="color: var(--success);">SUPPORTS</strong> the claim that economic freedom correlates with better quality-of-life outcomes. ${summary.positive_correlations} out of ${summary.total_indices} indices show statistically significant positive correlations.`;
            } else if (summary.verdict === 'contradicts') {
                return `The data <strong style="color: var(--danger);">CONTRADICTS</strong> the claim that economic freedom correlates with better quality-of-life outcomes.`;
            } else {
                return `The data shows <strong style="color: var(--warning);">MIXED</strong> results regarding economic freedom and quality-of-life outcomes.`;
            }
        }

        function renderDataSources() {
            const sources = [
                {
                    name: "Economic Freedom Index",
                    org: "Heritage Foundation",
                    year: 2024,
                    desc: "Measures economic freedom based on rule of law, government size, regulatory efficiency, and open markets.",
                    url: "https://www.heritage.org/index/",
                    indices: ["Economic Freedom Score"]
                },
                {
                    name: "World Development Indicators",
                    org: "World Bank",
                    year: 2022,
                    desc: "Comprehensive development data including GDP per capita, life expectancy, and infant mortality rates.",
                    url: "https://data.worldbank.org/indicator",
                    indices: ["GDP per Capita", "Life Expectancy", "Infant Mortality"]
                },
                {
                    name: "Corruption Perceptions Index",
                    org: "Transparency International",
                    year: 2023,
                    desc: "Ranks countries by perceived levels of public sector corruption based on expert assessments.",
                    url: "https://www.transparency.org/en/cpi/2023",
                    indices: ["Anti-Corruption Score"]
                },
                {
                    name: "Human Development Index",
                    org: "United Nations Development Programme",
                    year: 2022,
                    desc: "Composite index measuring life expectancy, education, and per capita income indicators.",
                    url: "https://hdr.undp.org/data-center/human-development-index",
                    indices: ["HDI"]
                },
                {
                    name: "World Happiness Report",
                    org: "Gallup / UN Sustainable Development Solutions Network",
                    year: 2024,
                    desc: "Measures subjective well-being based on life evaluations, emotions, and social support.",
                    url: "https://worldhappiness.report/",
                    indices: ["Happiness Score"]
                },
                {
                    name: "Democracy Index",
                    org: "Economist Intelligence Unit",
                    year: 2023,
                    desc: "Measures democratic governance based on electoral process, civil liberties, and political participation.",
                    url: "https://www.eiu.com/n/campaigns/democracy-index-2023/",
                    indices: ["Democracy Score"]
                },
                {
                    name: "Global Social Mobility Index",
                    org: "World Economic Forum",
                    year: 2020,
                    desc: "Measures ability of individuals to move up the socioeconomic ladder regardless of background.",
                    url: "https://www.weforum.org/publications/global-social-mobility-index-2020/",
                    indices: ["Social Mobility Score"]
                },
                {
                    name: "Cost of Living Index",
                    org: "Numbeo",
                    year: 2025,
                    desc: "Measures relative purchasing power based on consumer goods prices, rent, and local salaries.",
                    url: "https://www.numbeo.com/cost-of-living/rankings_by_country.jsp",
                    indices: ["Purchasing Power Index"]
                },
                {
                    name: "Pollution Index",
                    org: "Numbeo",
                    year: 2025,
                    desc: "Measures pollution levels based on air quality, water quality, waste management, and other environmental factors.",
                    url: "https://www.numbeo.com/pollution/rankings_by_country.jsp",
                    indices: ["Pollution Index"]
                }
            ];

            const linkIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>`;

            return sources.map(s => `
                <div class="source-card">
                    <h4>${s.name}</h4>
                    <div class="source-org">${s.org}</div>
                    <span class="source-year">${s.year}</span>
                    <div class="source-desc">${s.desc}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">
                        <strong>Used for:</strong> ${s.indices.join(", ")}
                    </div>
                    <a href="${s.url}" target="_blank" rel="noopener noreferrer">
                        View source ${linkIcon}
                    </a>
                </div>
            `).join('');
        }

        function renderCorrelationRow(c) {
            const isFavorable = c.effective_correlation > 0;
            const isInverted = c.correlation < 0;

            // Always show as positive value with green color, add "(Inverted)" to title if negative
            const displayCorrelation = Math.abs(c.correlation);
            const barColor = '#16a34a';
            const displayName = isInverted ? `${c.name} (Inverted)` : c.name;

            const barWidth = displayCorrelation * 50;
            const barLeft = 50;
            const barRadius = '0 8px 8px 0';

            let sigClass = 'low';
            let sigText = 'Not significant';
            if (c.p_value < 0.001) {
                sigClass = 'high';
                sigText = 'p < 0.001 ***';
            } else if (c.p_value < 0.01) {
                sigClass = 'high';
                sigText = 'p < 0.01 **';
            } else if (c.p_value < 0.05) {
                sigClass = 'medium';
                sigText = 'p < 0.05 *';
            }

            const directionIcon = isFavorable ? '↑' : '↓';
            const directionText = isFavorable ? 'Better outcomes' : 'Worse outcomes';
            const directionColor = isFavorable ? 'var(--success)' : 'var(--danger)';

            return `
                <tr>
                    <td><strong>${displayName}</strong><br><small style="color: var(--text-muted)">${c.unit}</small></td>
                    <td>
                        <span class="correlation-value" style="color: ${barColor}">${displayCorrelation.toFixed(3)}</span>
                        <div class="correlation-bar-container">
                            <span>-1</span>
                            <div class="correlation-bar">
                                <div class="correlation-bar-center"></div>
                                <div class="correlation-bar-fill" style="width: ${barWidth}%; left: ${barLeft}%; background: ${barColor}; border-radius: ${barRadius};"></div>
                            </div>
                            <span>1</span>
                        </div>
                    </td>
                    <td><span class="significance ${sigClass}">${sigText}</span></td>
                    <td class="direction-cell" style="color: ${directionColor}" data-n="n=${c.n}">
                        <span class="direction-icon">${directionIcon}</span>${directionText}
                    </td>
                    <td class="sample-size-cell">n = ${c.n}</td>
                </tr>
            `;
        }

        let scatterChart = null;

        function initScatterChart() {
            const ctx = document.getElementById('scatterChart').getContext('2d');
            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 35,
                            right: 20
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.country}: (${context.raw.x}, ${context.raw.y})`;
                                }
                            }
                        },
                        legend: {
                            display: true
                        },
                        annotation: {
                            clip: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            grace: 0,
                            title: {
                                display: true,
                                text: 'Economic Freedom Score'
                            },
                            ticks: {
                                autoSkip: false
                            }
                        },
                        y: {
                            type: 'linear',
                            grace: 0,
                            title: {
                                display: true,
                                text: ''
                            },
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                }
            });
            updateChart();
        }

        function updateChart() {
            const select = document.getElementById('indexSelect');
            const countrySelect = document.getElementById('countrySelect');
            const selectedId = select.value;
            const selectedCountry = countrySelect ? countrySelect.value : '';
            const data = window.analysisData;

            const scatterData = data.scatter_data[selectedId];
            const correlation = data.correlations.find(c => c.id === selectedId);

            if (!scatterData || !correlation) return;

            // Check if user manually changed the country (no longer auto-detected)
            if (selectedCountry && userCountry && selectedCountry.toLowerCase() !== userCountry.toLowerCase()) {
                isUserCountry = false;
            } else if (selectedCountry && userCountry && selectedCountry.toLowerCase() === userCountry.toLowerCase()) {
                isUserCountry = true;
            }

            const trendPoints = [];
            const slope = scatterData.trend_line.slope;
            const intercept = scatterData.trend_line.intercept;
            const [xMin, xMax] = scatterData.trend_line.x_range;

            for (let x = xMin; x <= xMax; x += (xMax - xMin) / 50) {
                trendPoints.push({ x: x, y: slope * x + intercept });
            }

            const isPositive = correlation.effective_correlation > 0;
            const pointColor = isPositive ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)';

            // Separate highlighted country from others
            const highlightedPoint = selectedCountry
                ? scatterData.points.find(p => p.country.toLowerCase() === selectedCountry.toLowerCase())
                : null;
            const otherPoints = selectedCountry
                ? scatterData.points.filter(p => p.country.toLowerCase() !== selectedCountry.toLowerCase())
                : scatterData.points;

            const datasets = [
                {
                    label: 'Countries',
                    data: otherPoints,
                    backgroundColor: pointColor,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    order: 2
                },
                {
                    label: `Trend (r = ${correlation.correlation.toFixed(3)})`,
                    data: trendPoints,
                    type: 'line',
                    borderColor: 'rgba(239, 68, 68, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    order: 3
                }
            ];

            // Add highlighted country as separate dataset
            if (highlightedPoint) {
                const labelText = isUserCountry ? `${selectedCountry} (You're here)` : selectedCountry;
                datasets.push({
                    label: labelText,
                    data: [highlightedPoint],
                    backgroundColor: 'rgba(37, 99, 235, 1)',
                    borderColor: 'rgba(30, 64, 175, 1)',
                    borderWidth: 2,
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    pointStyle: 'circle',
                    order: 0
                });
            }

            scatterChart.data.datasets = datasets;
            scatterChart.options.scales.y.title.text = correlation.name;

            // Calculate actual data bounds with 2% padding
            const allX = scatterData.points.map(p => p.x);
            const allY = scatterData.points.map(p => p.y);
            const xDataMin = Math.min(...allX);
            const xDataMax = Math.max(...allX);
            const yDataMin = Math.min(...allY);
            const yDataMax = Math.max(...allY);
            const xPadding = (xDataMax - xDataMin) * 0.07;
            const yPadding = (yDataMax - yDataMin) * 0.07;
            scatterChart.options.scales.x.min = xDataMin - xPadding;
            scatterChart.options.scales.x.max = xDataMax + xPadding;
            scatterChart.options.scales.x.bounds = 'data';
            scatterChart.options.scales.y.min = yDataMin - yPadding;
            scatterChart.options.scales.y.max = yDataMax + yPadding;
            scatterChart.options.scales.y.bounds = 'data';

            // Update annotation for highlighted country - position dynamically
            if (highlightedPoint && isUserCountry) {
                // Get the Y axis range to determine if point is near top
                const yScale = scatterChart.scales.y;
                const yRange = yScale.max - yScale.min;
                const pointYPercent = (highlightedPoint.y - yScale.min) / yRange;

                // If point is in top 30% of chart, show label below; otherwise above
                const yAdjust = pointYPercent > 0.7 ? 30 : -30;

                scatterChart.options.plugins.annotation = {
                    clip: false,
                    annotations: {
                        label1: {
                            type: 'label',
                            xValue: highlightedPoint.x,
                            yValue: highlightedPoint.y,
                            content: ["You're here"],
                            backgroundColor: 'rgba(37, 99, 235, 0.9)',
                            color: 'white',
                            font: { size: 11, weight: 'bold' },
                            padding: { top: 4, bottom: 4, left: 8, right: 8 },
                            borderRadius: 4,
                            yAdjust: yAdjust
                        }
                    }
                };
            } else {
                scatterChart.options.plugins.annotation = { annotations: {} };
            }

            scatterChart.update();

            const interpBox = document.getElementById('chartInterpretation');
            // Effective correlation > 0 means good outcomes (already adjusted for "lower is better" metrics)
            const favorable = correlation.effective_correlation > 0;
            // Use raw correlation to determine if values go up or down
            const rawCorrelationPositive = correlation.correlation > 0;
            interpBox.className = `interpretation-box ${favorable ? 'positive' : 'negative'}`;

            if (correlation.significant) {
                const direction = rawCorrelationPositive ? 'higher' : 'lower';
                const outcome = favorable ? 'better' : 'worse';
                let countryInfo = '';
                if (highlightedPoint) {
                    countryInfo = `<br><br><strong>${selectedCountry}:</strong> Economic Freedom: ${highlightedPoint.x}, ${correlation.name}: ${highlightedPoint.y}`;
                }
                const freedomVerdict = favorable
                    ? '<br><br><strong style="color: var(--success);">Is freedom better? Yes.</strong>'
                    : '<br><br><strong style="color: var(--danger);">Is freedom better? Not for this metric.</strong>';
                interpBox.innerHTML = `
                    Countries with higher economic freedom tend to have
                    <strong>${direction}</strong> ${correlation.name.toLowerCase()}, which represents
                    <strong>${outcome}</strong> outcomes (r = ${correlation.correlation.toFixed(2)}).${countryInfo}${freedomVerdict}
                `;
            } else {
                interpBox.innerHTML = `
                    No statistically significant relationship was found
                    between economic freedom and ${correlation.name.toLowerCase()}.
                    <br><br><strong style="color: var(--text-muted);">Is freedom better? The data doesn't say.</strong>
                `;
            }
        }

        function renderComparison() {
            const data = window.analysisData;
            const comparison = data.comparison;

            if (!comparison) return;

            const container = document.getElementById('comparisonSection');

            // Summary cards
            let html = `
                <div class="comparison-container">
                    <div class="comparison-grid">
            `;

            comparison.metrics.forEach(m => {
                const efCorr = m.economic_freedom.effective;
                const eqCorr = m.equality.effective;
                const efWidth = Math.round(efCorr * 100);
                const eqWidth = Math.round(eqCorr * 100);

                const winnerText = m.winner === 'economic_freedom'
                    ? '<span style="color: var(--success); font-weight: bold;">Freedom</span>'
                    : m.winner === 'equality'
                        ? '<span style="color: var(--danger); font-weight: bold;">Equality</span>'
                        : '<span style="color: var(--warning);">Tie</span>';

                html += `
                    <div class="comparison-row">
                        <div class="comparison-metric">
                            <strong>${m.metric}</strong>
                        </div>
                        <div class="comparison-bar-col" data-label="Economic Freedom">
                            <div class="comparison-bar-wrapper">
                                <div class="comparison-bar-track">
                                    <div class="comparison-bar-fill-green" style="width: ${efWidth}%;"></div>
                                </div>
                                <span class="comparison-value" style="color: var(--success);">${efCorr.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="comparison-bar-col" data-label="Equality (Gini)">
                            <div class="comparison-bar-wrapper">
                                <div class="comparison-bar-track">
                                    <div class="comparison-bar-fill-red" style="width: ${eqWidth}%;"></div>
                                </div>
                                <span class="comparison-value" style="color: var(--danger);">${eqCorr.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="comparison-winner">
                            ${winnerText}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
                <div class="comparison-conclusion">
                    <strong>So, is freedom better?</strong> When it comes to quality of life, economic freedom wins in <strong>${comparison.economic_freedom_wins} out of ${comparison.metrics.length}</strong> metrics. The data suggests: yes, freedom is better.
                </div>
            `;

            container.innerHTML = html;
        }

        // Contact form - send to Telegram
        async function sendContactMessage(event) {
            event.preventDefault();

            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const message = document.getElementById('contactMessage').value.trim();
            const statusDiv = document.getElementById('contactStatus');
            const submitBtn = document.getElementById('contactSubmit');

            if (!message) {
                statusDiv.innerHTML = '<span style="color: var(--danger);">Please enter a message.</span>';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            // Format the message
            let telegramMessage = '📬 A new message from Capitalism\n\n';
            if (name) telegramMessage += `👤 Name: ${name}\n`;
            if (email) telegramMessage += `📧 Email: ${email}\n`;
            telegramMessage += `\n💬 Message:\n${message}`;

            const botToken = '8338347162:AAFpBkN-tR0ZFiK4stYf4riflq7bcUEgd2M';
            const chatId = '484630945';

            try {
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: telegramMessage,
                        parse_mode: 'HTML'
                    })
                });

                const result = await response.json();

                if (result.ok) {
                    statusDiv.innerHTML = '<span style="color: var(--success);">Message sent successfully! Thanks for reaching out.</span>';
                    document.getElementById('contactForm').reset();
                } else {
                    throw new Error(result.description || 'Failed to send message');
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: var(--danger);">Failed to send message. Please try again later.</span>`;
                console.error('Telegram error:', error);
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Message';
        }

        // Handle hash navigation
        function handleHash() {
            const hash = window.location.hash;
            if (hash === '#data') {
                navigateTo(1);
            } else if (hash === '#about') {
                navigateTo(2);
            } else if (hash === '#contact') {
                navigateTo(3);
            }
        }

        // Initialize nav indicator position
        function initNavIndicator() {
            const activeLink = document.querySelector('nav a.active');
            const indicator = document.querySelector('.nav-indicator');
            if (activeLink && indicator) {
                indicator.style.left = activeLink.offsetLeft + 'px';
                indicator.style.width = activeLink.offsetWidth + 'px';
            }
        }

        // Load data on page load
        loadData();
        handleHash();
        initNavIndicator();
        window.addEventListener('hashchange', handleHash);
        window.addEventListener('resize', initNavIndicator);
    </script>
</body>
</html>
