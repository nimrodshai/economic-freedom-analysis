<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <title>Is Freedom Better? | Do Freer Countries Have Better Quality of Life?</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon180.png">

    <!-- SEO Meta Tags -->
    <meta name="description" content="Do countries with freer markets have happier, healthier, wealthier citizens? We analyzed 150+ countries. The answer: yes, and the data is clear.">
    <meta name="keywords" content="economic freedom, quality of life, free market, capitalism, happiness index, GDP per capita, life expectancy, country comparison, economic data">
    <meta name="author" content="Is Freedom Better">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://isfreedombetter.com/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://isfreedombetter.com/">
    <meta property="og:title" content="Is Freedom Better? | Data-Driven Analysis">
    <meta property="og:description" content="Do countries with freer markets have better quality of life? We analyzed 150+ countries. The answer is yes.">
    <meta property="og:image" content="https://isfreedombetter.com/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:site_name" content="Is Freedom Better">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://isfreedombetter.com/">
    <meta name="twitter:title" content="Is Freedom Better? | Data-Driven Analysis">
    <meta name="twitter:description" content="Do countries with freer markets have better quality of life? We analyzed 150+ countries. The answer is yes.">
    <meta name="twitter:image" content="https://isfreedombetter.com/og-image.jpg">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "Is Freedom Better",
        "url": "https://isfreedombetter.com",
        "description": "Data-driven analysis of economic freedom versus quality of life across countries",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://isfreedombetter.com/?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Dataset",
        "name": "Economic Freedom vs Quality of Life Dataset",
        "description": "Comprehensive dataset comparing economic freedom indices with quality of life metrics across 150+ countries",
        "url": "https://isfreedombetter.com/data.json",
        "license": "https://creativecommons.org/licenses/by/4.0/",
        "creator": {
            "@type": "Organization",
            "name": "Is Freedom Better"
        },
        "distribution": {
            "@type": "DataDownload",
            "encodingFormat": "application/json",
            "contentUrl": "https://isfreedombetter.com/data.json"
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

    <!-- PostHog Analytics -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog && window.posthog.__loaded)||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init ts ns yi rs os Qr es capture Hi calculateEventProperties hs register register_once register_for_session unregister unregister_for_session fs getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey cancelPendingSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException startExceptionAutocapture stopExceptionAutocapture loadToolbar get_property getSessionProperty vs us createPersonProfile cs Yr ps opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing ls debug O ds getPageViewId captureTraceFeedback captureTraceMetric Vr".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('phc_jK5vMFxp1Mki4dE22LE0Br5awvNoUsoLTbxO5cTZlAj', {
            api_host: 'https://us.i.posthog.com',
            defaults: '2025-11-30',
            person_profiles: 'identified_only'
        })
    </script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #d97706;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            overflow-x: hidden;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-weight: 300;
            background: linear-gradient(180deg, #0f172a 0%, #1e3a5f 120px, #2563eb 320px, #f1f5f9 480px);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
        }

        h1, h2, h3 {
            font-weight: 500;
        }

        header {
            text-align: center;
            padding: 40px 20px 15px;
            background: transparent;
            color: white;
        }

        header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0;
            line-height: 1.1;
            letter-spacing: -0.02em;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 30px;
            position: relative;
        }

        nav a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            padding: 8px 0;
            font-size: 0.95rem;
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        nav a:hover {
            color: white;
        }

        nav a.active {
            color: white;
        }

        .nav-indicator {
            position: absolute;
            bottom: 0;
            height: 2px;
            background: white;
            transition: left 0.3s ease, width 0.3s ease;
            pointer-events: none;
        }

        /* Sliding panels */
        .panels-wrapper {
            overflow: hidden;
            position: relative;
        }

        .panels-container {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 400%;
        }

        .panel {
            width: 25%;
            flex-shrink: 0;
            min-height: calc(100vh - 200px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        .card h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .card .value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .card .value.positive { color: var(--success); }
        .card .value.negative { color: var(--danger); }
        .card .value.neutral { color: var(--warning); }

        .card .label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .verdict-card {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px;
            margin-bottom: 80px;
        }

        .verdict-card .verdict {
            font-size: 1.3rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .section {
            margin-top: 60px;
            margin-bottom: 40px;
        }

        .section h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        /* Section title styling */
        .page-break {
            text-align: center;
            margin: 40px 0 30px;
            padding: 0;
        }

        .page-break h2 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin: 0 0 8px 0;
            padding: 0;
            border: none;
        }

        .page-break p {
            color: var(--text-muted);
            margin: 0;
            font-size: 1rem;
        }

        .results-stat-row {
            display: flex !important;
            flex-direction: row;
            justify-content: center;
            gap: 40px;
            margin: 24px 0;
            padding: 20px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .results-stat-item {
            text-align: center;
        }

        .results-stat-num {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .results-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (min-width: 768px) {
            .page-break h2 {
                font-size: 2.2rem;
            }
        }

        @media (max-width: 768px) {
            .results-stat-row {
                gap: 24px;
            }
            .results-stat-num {
                font-size: 1.8rem;
            }
        }

        /* Correlations table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            background: var(--card-bg);
        }

        .correlations-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            min-width: 600px;
        }

        .correlations-table th,
        .correlations-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .correlations-table th {
            background: #f1f5f9;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mobile-note { display: none; }

        .correlations-table tr:hover {
            background: #f8fafc;
        }

        .correlation-value {
            font-weight: 600;
            font-family: monospace;
            font-size: 1rem;
            display: inline-block;
            width: 70px;
            text-align: right;
        }

        .correlation-bar-container {
            display: inline-flex;
            align-items: center;
            margin-left: 10px;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .correlation-bar {
            width: 120px;
            height: 12px;
            background: #e2e8f0;
            border-radius: 4px;
            position: relative;
            margin: 0 5px;
        }

        .correlation-bar-center {
            position: absolute;
            left: 50%;
            top: -2px;
            bottom: -2px;
            width: 2px;
            background: #94a3b8;
            transform: translateX(-50%);
        }

        .correlation-bar-fill {
            position: absolute;
            height: 100%;
        }

        .significance {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .significance.high { background: #dcfce7; color: #166534; }
        .significance.medium { background: #fef9c3; color: #854d0e; }
        .significance.low { background: #fee2e2; color: #991b1b; }

        .direction-icon {
            font-size: 1.2rem;
            margin-right: 5px;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        .chart-container h3 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .interpretation-box {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .interpretation-box.positive {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #16a34a;
        }

        .interpretation-box.negative {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }

        .chart-selector {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .selector-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selector-row label {
            font-weight: 500;
            white-space: nowrap;
        }

        .chart-selector select {
            padding: 10px 15px;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            min-width: 200px;
        }

        /* Data sources */
        .data-sources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
        }

        .source-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .source-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
        }

        .source-card h4 {
            font-size: 1rem;
            margin-bottom: 8px;
            color: var(--text);
        }

        .source-card .source-org {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .source-card .source-year {
            display: inline-block;
            background: #e0f2fe;
            color: #0369a1;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .source-card .source-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .source-card a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .source-card a:hover {
            text-decoration: underline;
        }

        .source-card a svg {
            width: 16px;
            height: 16px;
        }

        /* Heatmap */
        .heatmap-table {
            border-collapse: collapse;
            font-size: 0.85rem;
            width: 100%;
            min-width: 700px;
        }

        .heatmap-table th,
        .heatmap-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .heatmap-table th {
            background: #f8fafc;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text);
        }

        .heatmap-table th.row-header {
            text-align: right;
            padding-right: 12px;
            background: #f8fafc;
            white-space: nowrap;
        }

        .heatmap-table td {
            font-weight: 600;
            font-family: monospace;
            transition: transform 0.1s;
        }

        .heatmap-table td:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: relative;
            z-index: 1;
        }

        .caveats {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
        }

        .caveats h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .caveats ul {
            color: #78350f;
            margin-left: 20px;
        }

        /* Raw Data Panel Styles */
        .controls {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .controls label {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .controls input[type="text"] {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            width: 250px;
        }

        .controls select {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: white;
        }

        .download-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .download-btn:hover {
            background: #1d4ed8;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        .stat-card .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 70vh;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 1200px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: #f1f5f9;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 41px;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .data-table .header-groups th {
            top: 0;
            z-index: 11;
            cursor: default;
        }

        .data-table th:hover {
            background: #e2e8f0;
        }

        .data-table th .sort-icon {
            margin-left: 5px;
            opacity: 0.3;
        }

        .data-table th.sorted .sort-icon {
            opacity: 1;
        }

        .data-table tr {
            transition: background-color 0.2s ease;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .data-table td {
            font-family: monospace;
        }

        .data-table td.country-name {
            font-family: inherit;
            font-weight: 500;
        }

        .data-table td.region {
            font-family: inherit;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Sticky columns for horizontal scrolling */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 5;
            background: #f1f5f9;
        }

        .data-table td:nth-child(1) {
            background: white;
        }

        .data-table tr:hover td:nth-child(1) {
            background: #f8fafc;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            position: sticky;
            left: 50px;
            z-index: 5;
            background: #f1f5f9;
        }

        .data-table td:nth-child(2) {
            background: white;
        }

        .data-table tr:hover td:nth-child(2) {
            background: #f8fafc;
        }

        /* Ensure sticky header cells have higher z-index */
        .data-table th:nth-child(1),
        .data-table th:nth-child(2) {
            z-index: 15;
        }

        /* Make header-groups first cell sticky for horizontal scroll */
        .data-table .header-groups th:first-child {
            position: sticky;
            left: 0;
            z-index: 16;
            min-width: 200px;
        }

        /* Region cell in header-groups - sticky for vertical scroll, not horizontal */
        .data-table .header-groups th:nth-child(2) {
            position: sticky;
            left: auto;
        }

        /* Method Indices and Quality of Life headers stick at Country edge when scrolling horizontally */
        .data-table .header-groups th:nth-child(3),
        .data-table .header-groups th:nth-child(4) {
            position: sticky;
            left: 200px;
            z-index: 16;
            box-shadow: -10px 0 0 #eef0fd;
        }

        /* Quality of Life needs its own shadow color */
        .data-table .header-groups th:nth-child(4) {
            box-shadow: -10px 0 0 #ecf5ef;
        }

        /* About Panel Styles */
        .about-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .about-card h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .about-card p {
            margin-bottom: 15px;
        }

        .about-card p:last-child {
            margin-bottom: 0;
        }

        .about-card ul {
            margin: 15px 0 15px 20px;
        }

        .about-card li {
            margin-bottom: 8px;
        }

        .methodology-step {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-content h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .step-content p {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-bottom: 0;
        }

        .disclaimer {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .disclaimer h3 {
            color: #92400e;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .disclaimer p {
            color: #78350f;
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            margin-top: 40px;
        }

        .legal-disclaimer {
            max-width: 800px;
            margin: 20px auto 0;
            padding: 15px 20px;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            line-height: 1.5;
            text-align: left;
        }

        .legal-disclaimer p {
            margin: 0;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Comparison section styles */
        .comparison-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
        }

        .comparison-header {
            display: none;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        @media (max-width: 1000px) {
            .comparison-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 650px) {
            .comparison-grid { grid-template-columns: 1fr; }
        }

        .category-header {
            grid-column: 1 / -1;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            padding: 20px 0 8px;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 4px;
        }
        .category-header:first-child {
            padding-top: 0;
        }

        /* 3D Card Flip */
        .card-flip-container {
            perspective: 1000px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .card-flip {
            position: relative;
            width: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .card-flip-container.flipped .card-flip {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            border-radius: 10px;
        }

        .card-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        .card-back-text {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text);
        }

        .card-back-text .winner-name {
            font-weight: 700;
        }

        .card-back-text .winner-name.freedom { color: var(--success); }
        .card-back-text .winner-name.equality { color: var(--danger); }
        .card-back-text .winner-name.democracy { color: #3b82f6; }

        .card-info-hint {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--text-muted);
            color: white;
            font-size: 12px;
            font-weight: 600;
            font-style: italic;
            font-family: Georgia, serif;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: opacity 0.2s ease 0.3s;
            z-index: 5;
        }

        .card-flip-container:hover .card-info-hint {
            opacity: 0.8;
        }

        .card-flip-container.flipped .card-info-hint {
            opacity: 0;
            transition: opacity 0.2s ease 0s;
        }

        .comparison-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .comparison-metric {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        .comparison-bar-col {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .comparison-bar-col::before {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 70px;
        }
        .comparison-bar-col[data-label="Freedom"]::before { content: "Freedom"; color: var(--success); }
        .comparison-bar-col[data-label="Equality"]::before { content: "Equality"; color: var(--danger); }
        .comparison-bar-col[data-label="Democracy"]::before { content: "Democracy"; color: #3b82f6; }
        .comparison-winner {
            display: none;
        }

        .comparison-bar-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .comparison-bar-track {
            flex: 1;
            height: 24px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .comparison-bar-fill-green {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            border-radius: 4px;
        }

        .comparison-bar-fill-red {
            height: 100%;
            background: linear-gradient(90deg, #f87171, #dc2626);
        }

        .comparison-bar-fill-blue {
            height: 100%;
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            border-radius: 4px;
        }

        .comparison-value {
            font-family: monospace;
            font-weight: 600;
            min-width: 50px;
        }

        .comparison-conclusion {
            margin-top: 20px;
            padding: 16px;
            background: #dcfce7;
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        .comparison-results-chart {
            margin-top: 24px;
            padding: 24px 20px 20px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .results-chart-title {
            text-align: center;
            margin-bottom: 80px;
            font-size: 1.05rem;
            color: var(--text-muted);
        }

        .results-bars {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 50px;
            height: 220px;
            padding-bottom: 10px;
        }

        .results-bar-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .results-bar-container {
            width: 80px;
            height: 180px;
            background: #e2e8f0;
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: flex-end;
        }

        .results-bar-fill {
            width: 100%;
            border-radius: 8px;
            transition: height 0.5s ease;
        }

        .results-bar-value {
            font-weight: 700;
            font-size: 1.4rem;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5), 0 0 8px rgba(0,0,0,0.3);
        }

        .results-bar-label {
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
        }

        .crown {
            position: absolute;
            top: -85px;
            left: calc(50% + 17px);
            transform: translateX(-50%) rotate(12deg);
            font-size: 5rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            z-index: 10;
            animation: crown-bounce 0.5s ease;
        }

        @keyframes crown-bounce {
            0%, 100% { transform: translateX(-50%) rotate(12deg) translateY(0); }
            50% { transform: translateX(-50%) rotate(12deg) translateY(-3px); }
        }

        .results-bar-breakdown {
            position: absolute;
            top: 17px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5), 0 0 8px rgba(0,0,0,0.3);
        }

        .results-bar-total {
            font-weight: 700;
            font-size: 1.8rem;
            line-height: 1.2;
        }

        .results-bar-detail {
            font-size: 0.75rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        .comparison-verdict {
            margin-top: 24px;
            padding: 24px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            border: 2px solid var(--success);
            text-align: center;
            font-size: 1.25rem;
            line-height: 1.6;
        }

        /* Floating "skip to verdict" button - mobile only */
        .skip-to-verdict {
            position: fixed;
            top: 50svh;
            left: 50%;
            transform: translate(-50%, 100px);
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            cursor: pointer;
            border: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease,
                        visibility 0.3s ease,
                        box-shadow 0.2s ease;
        }

        .skip-to-verdict:active {
            transform: translate(-50%, -100%) scale(0.95);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .skip-to-verdict.visible {
            transform: translate(-50%, -100%);
            opacity: 1;
            visibility: visible;
        }

        /* Responsive text visibility */
        .desktop-only { display: inline; }
        .mobile-only { display: none; }
        div.mobile-only { display: none; }
        div.desktop-only { display: block; }

        /* Mobile intro hero styles */
        .intro-hero {
            text-align: center;
            margin-bottom: 40px;
            max-width: 750px;
            margin-left: auto;
            margin-right: auto;
            padding: 24px 20px;
            background: linear-gradient(180deg, #dbeafe 0%, #eef6ff 40%, #ffffff 100%);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.15);
        }
        .intro-hero .big-question {
            color: var(--text);
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 16px;
        }
        .intro-hero .intro-description {
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.6;
            margin-top: 24px;
        }
        .intro-hero .methodology {
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.6;
            margin-top: 16px;
            margin-bottom: 20px;
        }
        .intro-hero .country-stat {
            display: inline-block;
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
        }
        .intro-hero .country-label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Stat row in intro - desktop */
        .intro-hero .stat-row.desktop-only {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 0 0 24px 0;
            padding: 0 0 20px 0;
            border-bottom: 1px solid var(--border);
        }
        .intro-hero .stat-row .stat-item {
            text-align: center;
        }
        .intro-hero .stat-row .stat-num {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }
        .intro-hero .stat-row .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Scroll number animation */
        .scroll-num-container {
            height: 1.2em;
            overflow: hidden;
            display: inline-block;
            vertical-align: bottom;
        }
        .scroll-num-inner {
            display: flex;
            flex-direction: column;
        }
        .scroll-num-inner span {
            height: 1.2em;
            line-height: 1.2em;
            text-align: center;
        }

        @media (max-width: 768px) {
            header { padding: 30px 15px; }
            header h1 { font-size: 2.5rem; }
            .desktop-only { display: none !important; }
            div.desktop-only { display: none !important; }
            .mobile-only { display: inline; }
            div.mobile-only { display: flex; }

            /* Mobile intro redesign */
            .intro-hero {
                margin-bottom: 32px;
                padding: 20px 15px;
                background: linear-gradient(180deg, #dbeafe 0%, #eef6ff 40%, #ffffff 100%);
                border-radius: 16px;
                margin-top: -10px;
                box-shadow: 0 4px 20px rgba(37, 99, 235, 0.15);
            }
            .intro-hero .big-question {
                font-size: 1.4rem;
                font-weight: 600;
                line-height: 1.4;
                margin-bottom: 8px;
                color: var(--text);
            }
            .intro-hero .methodology {
                font-size: 0.95rem;
                line-height: 1.5;
            }
            .intro-hero .country-stat {
                font-size: 3.5rem;
                margin-bottom: 8px;
            }
            .intro-hero .stat-row {
                display: flex;
                justify-content: center;
                gap: 32px;
                margin: 8px 0;
                padding: 16px 0;
                border-top: 1px solid var(--border);
                border-bottom: 1px solid var(--border);
            }
            .intro-hero .stat-item {
                text-align: center;
            }
            .intro-hero .stat-num {
                font-size: 2rem;
                font-weight: 700;
                color: var(--primary);
                display: block;
            }
            .intro-hero .stat-label {
                font-size: 0.75rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Better section headers on mobile */
            .section h2 {
                font-size: 1.4rem;
                font-weight: 700;
                margin-bottom: 12px;
            }
            .section > p {
                font-size: 0.9rem;
            }
            .container { padding: 15px; }
            .charts-grid { grid-template-columns: 1fr; }
            .chart-selector { flex-direction: column; align-items: stretch; }
            .selector-row { flex-direction: column; align-items: stretch; gap: 5px; }
            .chart-selector select { min-width: 100%; }
            .chart-wrapper { height: 300px; }
            /* Mobile: Compact data-dense layout */
            .correlations-table { min-width: auto; font-size: 0.8rem; }
            .correlations-table thead { display: none; }
            .correlations-table tbody { display: flex; flex-direction: column; gap: 0; }
            .correlations-table tr {
                display: grid;
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                gap: 6px 12px;
                padding: 12px 14px;
                align-items: center;
                border-bottom: 1px solid var(--border);
                background: var(--card-bg);
            }
            .correlations-table tr:hover { background: #f8fafc; }
            .correlations-table td:first-child {
                display: block;
                grid-column: 1;
                grid-row: 1;
                padding: 0;
                border: none;
            }
            .correlations-table td:first-child strong { font-size: 0.9rem; }
            .correlations-table td:first-child small,
            .correlations-table td:first-child br { display: none; }
            .correlations-table td:nth-child(2) {
                grid-column: 2;
                grid-row: 1 / 3;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                justify-content: center;
                gap: 2px;
                padding: 0;
                border: none;
            }
            .correlation-value { font-size: 1.2rem; font-weight: 700; width: auto; text-align: right; }
            .correlation-bar-container { display: flex; flex-direction: row; align-items: center; margin-left: 0; gap: 4px; }
            .correlation-bar { width: 140px; height: 16px; border-radius: 8px; }
            .correlation-bar-container > span { font-size: 0.6rem; color: var(--text-muted); }
            .correlations-table td:nth-child(3) { display: none; }
            .correlations-table .direction-cell {
                display: block;
                grid-column: 1;
                grid-row: 2;
                padding: 0;
                border: none;
                font-size: 0.7rem;
                text-align: left;
            }
            .correlations-table .direction-cell::after {
                content: " Â· " attr(data-n);
                color: var(--text-muted);
            }
            .correlations-table .sample-size-cell {
                display: none;
            }
            .direction-icon { font-size: 0.8rem; vertical-align: middle; }
            .mobile-note { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px; }
            .summary-cards { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .card { padding: 16px; }
            .card .value { font-size: 2rem; }
            .verdict-card { grid-column: 1 / -1; }
            .data-sources { grid-template-columns: 1fr; }
            .source-card { padding: 15px; }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .controls input[type="text"] {
                width: 100%;
            }
            .download-btn {
                margin-left: 0;
                justify-content: center;
            }
            .stats { gap: 10px; }
            .stat-card { padding: 12px 15px; flex: 1; min-width: 0; }
            .stat-card .value { font-size: 1.2rem; }
            .about-card { padding: 20px; }
            .methodology-step { flex-direction: column; gap: 10px; }
            .section h2 { font-size: 1.25rem; }
        }

        @media (max-width: 480px) {
            header h1 { font-size: 1.8rem; }
            nav { gap: 16px; margin-top: 20px; }
            nav a { font-size: 0.85rem; padding: 6px 0; }
            .summary-cards { grid-template-columns: 1fr; }
            .card .value { font-size: 1.8rem; }
            .correlations-table tr { padding: 10px 12px; }
            .correlations-table td:first-child strong { font-size: 0.85rem; }
            .correlation-value { font-size: 1rem; width: auto; }
            .correlation-bar { width: 120px; height: 16px; }
            .correlations-table td:nth-child(4) { font-size: 0.65rem; }
            .correlations-table td:nth-child(5) { font-size: 0.65rem; }
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        .modal-overlay.active {
            display: flex;
        }
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalFadeIn 0.2s ease;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            z-index: 1;
            border-radius: 16px 16px 0 0;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--text);
        }
        .modal-close {
            background: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px 8px;
            line-height: 1;
            border-radius: 4px;
        }
        .modal-close:hover {
            color: var(--text);
            background: #f1f5f9;
        }
        .modal-body {
            padding: 20px 24px 24px;
        }
        .predictor-item {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e2e8f0;
        }
        .predictor-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .predictor-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .predictor-title.freedom { color: var(--success); }
        .predictor-title.equality { color: var(--danger); }
        .predictor-title.democracy { color: #3b82f6; }
        .predictor-desc {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .predictor-source {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .predictor-source a {
            color: var(--primary);
        }
        .info-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }
        .info-link:hover {
            text-decoration-style: solid;
        }
    </style>
</head>
<body>
    <header>
        <h1>Is Freedom Better?</h1>
        <nav>
            <a onclick="navigateTo(0)" class="active" data-panel="0">Dashboard</a>
            <a onclick="navigateTo(1)" data-panel="1">Raw Data</a>
            <a onclick="navigateTo(2)" data-panel="2">About</a>
            <a onclick="navigateTo(3)" data-panel="3">Contact</a>
            <span class="nav-indicator"></span>
        </nav>
    </header>

    <div class="panels-wrapper">
        <div class="panels-container" id="panelsContainer">
            <!-- Dashboard Panel -->
            <div class="panel" id="dashboardPanel">
                <div class="container">
                    <div id="dashboardContent" class="loading">Loading analysis data...</div>
                </div>
            </div>

            <!-- Raw Data Panel -->
            <div class="panel" id="dataPanel">
                <div class="container">
                    <div id="dataContent" class="loading">Loading data...</div>
                </div>
            </div>

            <!-- About Panel -->
            <div class="panel" id="aboutPanel">
                <div class="container">
                    <div class="about-card">
                        <h2>Why We Built This</h2>
                        <p>Everyone has opinions about what makes societies thrive. Some say it's freedom. Others say it's equality. Many point to democracy. But what does the data actually show?</p>
                        <p>We wanted to cut through the noise and let the numbers speak. So we gathered data from 150+ countries and asked a simple question: which ideas actually correlate with people living better lives?</p>
                    </div>

                    <div class="about-card">
                        <h2>A Note on What This Can (and Can't) Tell Us</h2>
                        <p>Let's be honest: <strong>correlation isn't causation</strong>. We can't prove that economic freedom <em>causes</em> better outcomes. We can't run experiments on entire nations or rewind history to test different policies.</p>
                        <p>But here's the thing â when you're studying something as complex as human societies, correlation is often the best tool we have. And when you see the same patterns showing up again and again, across different metrics, from different organizations, covering different aspects of life... that's worth paying attention to.</p>
                        <p>Think of this as a compass, not a GPS. It points in a direction, even if it can't tell you exactly how to get there.</p>
                    </div>

                    <div class="about-card">
                        <h2>How We Did It</h2>
                        <div class="methodology-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h3>Gather the Data</h3>
                                <p>We pull fresh data from trusted sources â the World Bank, UN, Heritage Foundation, and others. No cherry-picking, no outdated numbers.</p>
                            </div>
                        </div>
                        <div class="methodology-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h3>Match the Countries</h3>
                                <p>We line up countries across all datasets. If a country doesn't have data for a specific metric, we leave it out of that comparison. Simple as that.</p>
                            </div>
                        </div>
                        <div class="methodology-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h3>Crunch the Numbers</h3>
                                <p>We calculate Pearson correlations â a standard way to measure how strongly two things move together. Higher number = stronger relationship.</p>
                            </div>
                        </div>
                        <div class="methodology-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h3>Check Our Work</h3>
                                <p>We test for statistical significance (p < 0.05). This tells us whether the pattern is real or just random noise. Spoiler: the patterns here are real.</p>
                            </div>
                        </div>
                    </div>

                    <div class="about-card">
                        <h2>Where the Data Comes From</h2>
                        <p>We don't make anything up. Every number comes from established international organizations:</p>
                        <ul>
                            <li><strong>Economic Freedom:</strong> <a href="https://www.heritage.org/index/" target="_blank" rel="noopener">Heritage Foundation</a></li>
                            <li><strong>GDP & Health:</strong> <a href="https://data.worldbank.org/indicator" target="_blank" rel="noopener">World Bank</a></li>
                            <li><strong>Corruption:</strong> <a href="https://www.transparency.org/en/cpi" target="_blank" rel="noopener">Transparency International</a></li>
                            <li><strong>Human Development:</strong> <a href="https://hdr.undp.org/data-center/human-development-index" target="_blank" rel="noopener">United Nations</a></li>
                            <li><strong>Happiness:</strong> <a href="https://worldhappiness.report/" target="_blank" rel="noopener">World Happiness Report</a></li>
                            <li><strong>Social Mobility:</strong> <a href="https://www.weforum.org/publications/global-social-mobility-index-2020-why-economies-benefit-from-fixing-inequality/" target="_blank" rel="noopener">World Economic Forum</a></li>
                            <li><strong>Purchasing Power & Pollution:</strong> <a href="https://www.numbeo.com/" target="_blank" rel="noopener">Numbeo</a></li>
                            <li><strong>Inequality:</strong> <a href="https://data.worldbank.org/indicator/SI.POV.GINI" target="_blank" rel="noopener">World Bank Gini Index</a></li>
                            <li><strong>Democracy:</strong> <a href="https://ourworldindata.org/grapher/democracy-index-eiu" target="_blank" rel="noopener">Economist Intelligence Unit</a></li>
                            <li><strong>Crime:</strong> <a href="https://www.numbeo.com/crime/rankings_by_country.jsp" target="_blank" rel="noopener">Numbeo</a></li>
                            <li><strong>Homicide Rate:</strong> <a href="https://data.worldbank.org/indicator/VC.IHR.PSRC.P5" target="_blank" rel="noopener">UNODC (via World Bank)</a></li>
                        </ul>
                    </div>

                    <div class="about-card">
                        <h2>Reading the Numbers</h2>
                        <p>Not sure what a correlation of 0.7 means? Here's a quick guide:</p>
                        <ul>
                            <li><strong>0.7 - 1.0:</strong> Strong relationship (these two things really move together)</li>
                            <li><strong>0.4 - 0.6:</strong> Moderate relationship (there's definitely something here)</li>
                            <li><strong>0.1 - 0.3:</strong> Weak relationship (a hint, but not much to write home about)</li>
                            <li><strong>Around 0:</strong> No relationship (these things don't seem connected)</li>
                        </ul>
                        <p>For context: Jacob Cohen's landmark 1988 work established that in social science, r = 0.5 counts as a "large" effect (<a href="https://www.sciencedirect.com/science/article/abs/pii/S0191886916308194" target="_blank" rel="noopener">Cohen, 1988</a>). Most published findings don't come close. The correlations here are above 0.5 â that's rare.</p>
                    </div>
                </div>
            </div>

            <!-- Contact Panel -->
            <div class="panel" id="contactPanel">
                <div class="container">
                    <div class="about-card">
                        <h2>Talk to Us</h2>
                        <p>Spotted a mistake? Have an idea? Just want to say hi? We're real people and we read every message. Drop us a line â we'd love to hear from you.</p>
                        <form id="contactForm" onsubmit="sendContactMessage(event)" style="margin-top: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label for="contactName" style="display: block; margin-bottom: 5px; font-weight: 500;">Name (optional)</label>
                                <input type="text" id="contactName" placeholder="Your name" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="contactEmail" style="display: block; margin-bottom: 5px; font-weight: 500;">Email (optional)</label>
                                <input type="email" id="contactEmail" placeholder="your@email.com" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="contactMessage" style="display: block; margin-bottom: 5px; font-weight: 500;">Message *</label>
                                <textarea id="contactMessage" placeholder="What's on your mind?" required rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                            </div>
                            <button type="submit" id="contactSubmit" style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 500;">Send Message</button>
                            <div id="contactStatus" style="margin-top: 15px;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p id="lastUpdated"></p>
        <p>Data is automatically refreshed weekly via GitHub Actions.</p>
        <div class="legal-disclaimer">
            <p><strong>Disclaimer:</strong> This website is for educational and informational purposes only. It does not constitute financial, investment, legal, or policy advice. Correlation does not imply causation. Data is sourced from third-party organizations and may contain errors or limitations. The authors make no guarantees regarding accuracy or completeness and accept no liability for decisions made based on this content. Always consult qualified professionals for advice specific to your situation.</p>
            <p style="margin-top: 10px;"><strong>Accessibility:</strong> We strive to make this website accessible to all users and aim to conform with WCAG 2.1 Level AA standards. If you encounter any accessibility barriers or have difficulty using any part of this site, please <a href="#contact" style="color: var(--primary);">contact us</a> and we will work to provide the information in an alternative format.</p>
        </div>
    </footer>

    <script>
        let currentPanel = 0;
        let allData = [];
        let sortColumn = 'economic_freedom';
        let sortDirection = 'desc';
        let userCountry = null;
        let isUserCountry = false;

        // Detect user's country via IP geolocation
        async function detectUserCountry() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                if (data.country_name) {
                    userCountry = data.country_name;
                    // Set the country selector if it exists and country is in our data
                    const countrySelect = document.getElementById('countrySelect');
                    if (countrySelect) {
                        const option = Array.from(countrySelect.options).find(
                            opt => opt.value.toLowerCase() === userCountry.toLowerCase()
                        );
                        if (option) {
                            countrySelect.value = option.value;
                            isUserCountry = true;
                            updateChart();
                        }
                    }
                }
            } catch (error) {
                console.log('Could not detect country:', error);
            }
        }

        // Navigation
        function navigateTo(panelIndex) {
            currentPanel = panelIndex;
            const container = document.getElementById('panelsContainer');
            container.style.transform = `translateX(-${panelIndex * 25}%)`;

            // Update nav active state and move indicator
            const indicator = document.querySelector('.nav-indicator');
            document.querySelectorAll('nav a').forEach(a => {
                a.classList.remove('active');
                if (parseInt(a.dataset.panel) === panelIndex) {
                    a.classList.add('active');
                    // Move indicator to this element
                    indicator.style.left = a.offsetLeft + 'px';
                    indicator.style.width = a.offsetWidth + 'px';
                }
            });

            // Update URL hash (without triggering hashchange)
            const hashes = ['', '#data', '#about', '#contact'];
            const pageNames = ['Dashboard', 'Raw Data', 'About', 'Contact'];
            history.replaceState(null, null, hashes[panelIndex] || window.location.pathname);

            // Track page view in PostHog
            if (window.posthog) {
                posthog.capture('$pageview', { page: pageNames[panelIndex] });
            }
        }

        // Fetch and render data
        async function loadData() {
            try {
                // Add cache-busting parameter to ensure fresh data
                const response = await fetch('data.json?v=' + Date.now());
                const data = await response.json();
                window.analysisData = data;
                allData = data.countries;
                renderDashboard(data);
                renderDataPanel(data);
                // Detect user country after charts are initialized
                detectUserCountry();
            } catch (error) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="card" style="text-align: center; color: var(--danger);">
                        <h3>Error Loading Data</h3>
                        <p>Could not load analysis data. Please try again later.</p>
                        <p style="font-size: 0.8rem; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderDashboard(data) {
            const content = document.getElementById('dashboardContent');
            content.classList.remove('loading');

            // Update last updated
            const date = new Date(data.metadata.generated_at);
            document.getElementById('lastUpdated').textContent =
                `Last updated: ${formatDatePretty(date)}`;

            content.innerHTML = `
                <!-- Quick Intro -->
                <div class="intro-hero">
                    <!-- Title -->
                    <p class="big-question">
                        Which conditions help societies thrive?
                    </p>

                    <!-- Stats row - desktop only at top -->
                    <div class="stat-row desktop-only">
                        <div class="stat-item">
                            <span class="stat-num count-up" data-target="${data.metadata.num_countries}">0</span>
                            <span class="stat-label">Countries</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num count-up" data-target="${data.correlations.length}">0</span>
                            <span class="stat-label">Metrics</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num count-up" data-target="3">0</span>
                            <span class="stat-label">Theories</span>
                        </div>
                    </div>

                    <!-- Description - desktop only -->
                    <p class="intro-description desktop-only">
                        What does it take for people to live good lives? We all want the same things â to be healthy, to provide for our families, to feel safe, and to have opportunities to grow. But which conditions actually help societies achieve these goals?
                    </p>

                    <!-- Stats row - mobile only after question -->
                    <div class="stat-row mobile-only">
                        <div class="stat-item">
                            <span class="stat-num count-up" data-target="${data.metadata.num_countries}">0</span>
                            <span class="stat-label">Countries</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num count-up" data-target="${data.correlations.length}">0</span>
                            <span class="stat-label">Metrics</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num count-up" data-target="3">0</span>
                            <span class="stat-label">Theories</span>
                        </div>
                    </div>

                    <p class="methodology">
                        <span class="desktop-only">We analyzed data from <strong>${data.metadata.num_countries} countries</strong> to find out. By comparing economic freedom, equality, and democracy <span class="info-link" onclick="openPredictorModal()">(what are these?)</span> against <span class="info-link" onclick="openOutcomesModal()">quality-of-life outcomes</span>, we can see what the evidence actually shows.</span>
                        <span class="mobile-only">We compared <span class="info-link" onclick="openPredictorModal()">policy theories</span> against indices that measure <span class="info-link" onclick="openOutcomesModal()">quality of life</span> to see which best predicts flourishing societies.</span>
                    </p>
                </div>

                <!-- Comparison Section - What matters most? -->
                <div class="page-break">
                    <h2>The Results</h2>
                    <p>Longer bars = stronger link to better lives.</p>
                </div>
                <div class="section-content">
                    <div id="comparisonSection"></div>
                </div>

                <!-- Interactive Charts -->
                <div class="page-break">
                    <h2>Explore the Data</h2>
                    <p>Each dot is a country â watch how they cluster.</p>
                </div>
                <div class="section-content">
                    <div class="chart-selector">
                        <div class="selector-row">
                            <label for="xAxisSelect">X-Axis: </label>
                            <select id="xAxisSelect" onchange="updateChart()">
                                <option value="economic_freedom">Economic Freedom</option>
                                <option value="democracy_score">Democracy</option>
                                <option value="gini_index">Equality (Gini inverted)</option>
                            </select>
                        </div>
                        <div class="selector-row">
                            <label for="indexSelect">Y-Axis: </label>
                            <select id="indexSelect" onchange="updateChart()">
                                ${data.correlations.map(c =>
                                    `<option value="${c.id}">${c.name}${c.higher_better === false ? ' (inverted)' : ''}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="selector-row">
                            <label for="countrySelect">Highlight: </label>
                            <select id="countrySelect" onchange="updateChart()">
                                <option value="">None</option>
                                ${data.countries
                                    .filter(c => c.economic_freedom)
                                    .sort((a, b) => a.name.localeCompare(b.name))
                                    .map(c => `<option value="${c.name}">${c.name}</option>`)
                                    .join('')}
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-wrapper">
                            <canvas id="scatterChart"></canvas>
                        </div>
                        <div id="chartInterpretation" class="interpretation-box positive"></div>
                    </div>
                </div>

                <!-- Data Sources -->
                <div class="page-break">
                    <h2>Data Sources</h2>
                    <p>All from reputable international organizations.<br>Click to verify.</p>
                </div>
                <div class="section-content">
                    <div class="data-sources">
                        ${renderDataSources()}
                    </div>
                    <div class="caveats">
                        <h3>Important Caveats</h3>
                        <ul>
                            <li><strong>Correlation does not imply causation.</strong> These relationships do not prove that economic freedom causes better outcomes.</li>
                            <li>Many confounding variables exist, including historical, geographical, and cultural factors.</li>
                            <li>Economic freedom indices have methodological limitations and biases.</li>
                            <li>Data availability and quality varies significantly by country.</li>
                        </ul>
                    </div>
                </div>

                            `;

            // Initialize charts
            initScatterChart();
            renderComparison();

            // Animate count-up numbers
            animateCountUp();
        }

        function animateCountUp() {
            const counters = document.querySelectorAll('.count-up');

            counters.forEach(counter => {
                const target = parseInt(counter.dataset.target);
                const digits = target.toString().split('');
                const numDigits = digits.length;

                counter.textContent = '';
                counter.style.display = 'inline-flex';

                digits.forEach((digit, index) => {
                    const digitValue = parseInt(digit);
                    const positionFromRight = numDigits - 1 - index;

                    // Create scroll container for this digit
                    const container = document.createElement('span');
                    container.className = 'scroll-num-container';

                    const inner = document.createElement('span');
                    inner.className = 'scroll-num-inner';

                    // Add target digit first, then 9 down to 0 (reversed order)
                    const finalSpan = document.createElement('span');
                    finalSpan.textContent = digitValue;
                    inner.appendChild(finalSpan);

                    for (let i = 9; i >= 0; i--) {
                        const span = document.createElement('span');
                        span.textContent = i;
                        inner.appendChild(span);
                    }

                    // Start from bottom (showing 0)
                    inner.style.transform = 'translateY(-12em)';

                    container.appendChild(inner);
                    counter.appendChild(container);

                    // Stagger: hundreds finish first (shortest delay), ones last (longest delay)
                    const delay = 100 + (index * 150);
                    const duration = 0.6 + (index * 0.2);

                    setTimeout(() => {
                        inner.style.transition = `transform ${duration}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
                        // Scroll up to show target digit at position 0
                        inner.style.transform = 'translateY(0)';
                    }, delay);
                });
            });
        }

        function renderDataPanel(data) {
            const content = document.getElementById('dataContent');
            content.classList.remove('loading');

            const lastUpdated = formatDatePretty(new Date(data.metadata.generated_at));

            content.innerHTML = `
                <div class="stats">
                    <div class="stat-card">
                        <div class="label">Countries</div>
                        <div class="value">${data.countries.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Data Points</div>
                        <div class="value">${data.countries.length * 10}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Last Updated</div>
                        <div class="value" style="font-size: 1rem;">${lastUpdated}</div>
                    </div>
                </div>

                <div class="controls">
                    <div>
                        <label for="search">Search Country: </label>
                        <input type="text" id="search" placeholder="Type country name..." oninput="filterTable()">
                    </div>
                    <div>
                        <label for="regionFilter">Filter by Region: </label>
                        <select id="regionFilter" onchange="filterTable()">
                            <option value="">All Regions</option>
                            ${getRegions().map(r => `<option value="${r}">${r}</option>`).join('')}
                        </select>
                    </div>
                    <button class="download-btn" onclick="downloadCSV()">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download CSV
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-scroll">
                        <table class="data-table" id="dataTable">
                            <thead>
                                <tr class="header-groups">
                                    <th colspan="2" style="background: #f1f5f9;"></th>
                                    <th style="background: #f1f5f9;"></th>
                                    <th colspan="3" style="background: #eef0fd; border-bottom: 2px solid var(--primary);">Method Indices</th>
                                    <th colspan="11" style="background: #ecf5ef; border-bottom: 2px solid var(--success);">Quality of Life Indices</th>
                                </tr>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th onclick="sortTable('name')">Country <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('region')">Region <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('economic_freedom')" class="sorted">Econ Freedom <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('gini_index')">Gini <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('democracy_score')">Democracy <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('gdp_per_capita')">GDP/Capita <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('life_expectancy')">Life Exp. <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('infant_mortality')">Infant Mort. <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('corruption_score')">Anti-Corrupt. <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('hdi')">HDI <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('happiness_score')">Happiness <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('social_mobility_score')">Social Mob. <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('purchasing_power_index')">Purch. Power <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('pollution_index')">Pollution <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('crime_index')">Crime <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('homicide_rate')">Homicide <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('hale')">Healthy Life <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('mental_health_index')">Mental Health <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('education_index')">Education <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('gender_inequality_index')">Gender Ineq. <span class="sort-icon">â</span></th>
                                    <th onclick="sortTable('poverty_rate')">Poverty <span class="sort-icon">â</span></th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            renderTable();
        }

        function getRegions() {
            const regions = [...new Set(allData.map(c => c.region).filter(r => r))];
            return regions.sort();
        }

        function renderTable() {
            const search = document.getElementById('search')?.value.toLowerCase() || '';
            const region = document.getElementById('regionFilter')?.value || '';

            let filtered = allData.filter(c => {
                const matchesSearch = c.name.toLowerCase().includes(search);
                const matchesRegion = !region || c.region === region;
                return matchesSearch && matchesRegion;
            });

            // Sort
            filtered.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                if (aVal === null || aVal === undefined) aVal = sortDirection === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined) bVal = sortDirection === 'asc' ? Infinity : -Infinity;

                if (sortColumn === 'name' || sortColumn === 'region') {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }

                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });

            const tbody = document.getElementById('tableBody');
            if (!tbody) return;

            tbody.innerHTML = filtered.map((c, index) => `
                <tr>
                    <td style="color: var(--text-muted); font-weight: 500;">${index + 1}</td>
                    <td class="country-name">${c.name}</td>
                    <td class="region">${c.region || '-'}</td>
                    <td>${formatLinkedValue(c.name, 'economic_freedom', c.economic_freedom, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'gini_index', c.gini_index, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'democracy_score', c.democracy_score, 2)}</td>
                    <td>${formatLinkedValue(c.name, 'gdp_per_capita', c.gdp_per_capita, 0, true)}</td>
                    <td>${formatLinkedValue(c.name, 'life_expectancy', c.life_expectancy, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'infant_mortality', c.infant_mortality, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'corruption_score', c.corruption_score, 0)}</td>
                    <td>${formatLinkedValue(c.name, 'hdi', c.hdi, 3)}</td>
                    <td>${formatLinkedValue(c.name, 'happiness_score', c.happiness_score, 2)}</td>
                    <td>${formatLinkedValue(c.name, 'social_mobility_score', c.social_mobility_score, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'purchasing_power_index', c.purchasing_power_index, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'pollution_index', c.pollution_index, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'crime_index', c.crime_index, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'homicide_rate', c.homicide_rate, 2)}</td>
                    <td>${formatLinkedValue(c.name, 'hale', c.hale, 1)}</td>
                    <td>${formatLinkedValue(c.name, 'mental_health_index', c.mental_health_index, 2)}</td>
                    <td>${formatLinkedValue(c.name, 'education_index', c.education_index, 3)}</td>
                    <td>${formatLinkedValue(c.name, 'gender_inequality_index', c.gender_inequality_index, 3)}</td>
                    <td>${formatLinkedValue(c.name, 'poverty_rate', c.poverty_rate, 1)}</td>
                </tr>
            `).join('');

            // Update header sort icons
            document.querySelectorAll('.data-table th').forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.textContent = 'â';
            });
            const sortedTh = document.querySelector(`.data-table th[onclick="sortTable('${sortColumn}')"]`);
            if (sortedTh) {
                sortedTh.classList.add('sorted');
                sortedTh.querySelector('.sort-icon').textContent = sortDirection === 'asc' ? 'â' : 'â';
            }
        }

        function formatValue(val, decimals, isCurrency = false) {
            if (val === null || val === undefined) {
                return '<span style="color: var(--text-muted); font-style: italic;">N/A</span>';
            }
            let formatted = decimals === 0 ? Math.round(val).toLocaleString() : val.toFixed(decimals);
            if (isCurrency) {
                formatted = '$' + formatted;
            }
            return formatted;
        }

        function formatDatePretty(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();

            // Add ordinal suffix
            let suffix = 'th';
            if (day === 1 || day === 21 || day === 31) suffix = 'st';
            else if (day === 2 || day === 22) suffix = 'nd';
            else if (day === 3 || day === 23) suffix = 'rd';

            return `${month} ${day}${suffix} ${year}`;
        }

        // ISO country codes for external links
        const countryISO = {
            'Afghanistan': 'AF', 'Albania': 'AL', 'Algeria': 'DZ', 'Angola': 'AO', 'Argentina': 'AR',
            'Armenia': 'AM', 'Australia': 'AU', 'Austria': 'AT', 'Azerbaijan': 'AZ', 'Bahrain': 'BH',
            'Bangladesh': 'BD', 'Belarus': 'BY', 'Belgium': 'BE', 'Belize': 'BZ', 'Benin': 'BJ',
            'Bhutan': 'BT', 'Bolivia': 'BO', 'Bosnia and Herzegovina': 'BA', 'Botswana': 'BW', 'Brazil': 'BR',
            'Brunei': 'BN', 'Bulgaria': 'BG', 'Burkina Faso': 'BF', 'Burundi': 'BI', 'Cambodia': 'KH',
            'Cameroon': 'CM', 'Canada': 'CA', 'Cape Verde': 'CV', 'Central African Republic': 'CF', 'Chad': 'TD',
            'Chile': 'CL', 'China': 'CN', 'Colombia': 'CO', 'Comoros': 'KM', 'Costa Rica': 'CR',
            'Croatia': 'HR', 'Cuba': 'CU', 'Cyprus': 'CY', 'Czech Republic': 'CZ', 'DR Congo': 'CD',
            'Denmark': 'DK', 'Djibouti': 'DJ', 'Dominican Republic': 'DO', 'Ecuador': 'EC', 'Egypt': 'EG',
            'El Salvador': 'SV', 'Equatorial Guinea': 'GQ', 'Estonia': 'EE', 'Ethiopia': 'ET', 'Fiji': 'FJ',
            'Finland': 'FI', 'France': 'FR', 'Gabon': 'GA', 'Gambia': 'GM', 'Georgia': 'GE',
            'Germany': 'DE', 'Ghana': 'GH', 'Greece': 'GR', 'Guatemala': 'GT', 'Guinea': 'GN',
            'Guyana': 'GY', 'Haiti': 'HT', 'Honduras': 'HN', 'Hong Kong': 'HK', 'Hungary': 'HU',
            'Iceland': 'IS', 'India': 'IN', 'Indonesia': 'ID', 'Iran': 'IR', 'Iraq': 'IQ',
            'Ireland': 'IE', 'Israel': 'IL', 'Italy': 'IT', 'Ivory Coast': 'CI', 'Jamaica': 'JM',
            'Japan': 'JP', 'Jordan': 'JO', 'Kazakhstan': 'KZ', 'Kenya': 'KE', 'Kuwait': 'KW',
            'Kyrgyzstan': 'KG', 'Laos': 'LA', 'Latvia': 'LV', 'Lebanon': 'LB', 'Lesotho': 'LS',
            'Liberia': 'LR', 'Libya': 'LY', 'Lithuania': 'LT', 'Luxembourg': 'LU', 'Madagascar': 'MG',
            'Malawi': 'MW', 'Malaysia': 'MY', 'Maldives': 'MV', 'Mali': 'ML', 'Malta': 'MT',
            'Mauritania': 'MR', 'Mauritius': 'MU', 'Mexico': 'MX', 'Moldova': 'MD', 'Mongolia': 'MN',
            'Montenegro': 'ME', 'Morocco': 'MA', 'Mozambique': 'MZ', 'Burma': 'MM', 'Namibia': 'NA',
            'Nepal': 'NP', 'Netherlands': 'NL', 'New Zealand': 'NZ', 'Nicaragua': 'NI', 'Niger': 'NE',
            'Nigeria': 'NG', 'North Korea': 'KP', 'North Macedonia': 'MK', 'Norway': 'NO', 'Oman': 'OM',
            'Pakistan': 'PK', 'Panama': 'PA', 'Papua New Guinea': 'PG', 'Paraguay': 'PY', 'Peru': 'PE',
            'Philippines': 'PH', 'Poland': 'PL', 'Portugal': 'PT', 'Qatar': 'QA', 'Romania': 'RO',
            'Russia': 'RU', 'Rwanda': 'RW', 'Saudi Arabia': 'SA', 'Senegal': 'SN', 'Serbia': 'RS',
            'Sierra Leone': 'SL', 'Singapore': 'SG', 'Slovakia': 'SK', 'Slovenia': 'SI', 'South Africa': 'ZA',
            'South Korea': 'KR', 'Spain': 'ES', 'Sri Lanka': 'LK', 'Sudan': 'SD', 'Suriname': 'SR',
            'Sweden': 'SE', 'Switzerland': 'CH', 'Syria': 'SY', 'Taiwan': 'TW', 'Tajikistan': 'TJ',
            'Tanzania': 'TZ', 'Thailand': 'TH', 'Togo': 'TG', 'Trinidad and Tobago': 'TT', 'Tunisia': 'TN',
            'Turkey': 'TR', 'Turkmenistan': 'TM', 'Uganda': 'UG', 'Ukraine': 'UA', 'UAE': 'AE',
            'United Kingdom': 'GB', 'United States': 'US', 'Uruguay': 'UY', 'Uzbekistan': 'UZ',
            'Venezuela': 'VE', 'Vietnam': 'VN', 'Yemen': 'YE', 'Zambia': 'ZM', 'Zimbabwe': 'ZW',
            'Kosovo': 'XK', 'Macedonia': 'MK', 'Congo': 'CG'
        };

        function getDataUrl(country, field) {
            const iso = countryISO[country] || '';
            const iso2to3 = {
                'AF': 'AFG', 'AL': 'ALB', 'DZ': 'DZA', 'AD': 'AND', 'AO': 'AGO', 'AG': 'ATG', 'AR': 'ARG', 'AM': 'ARM', 'AU': 'AUS', 'AT': 'AUT',
                'AZ': 'AZE', 'BS': 'BHS', 'BH': 'BHR', 'BD': 'BGD', 'BB': 'BRB', 'BY': 'BLR', 'BE': 'BEL', 'BZ': 'BLZ', 'BJ': 'BEN', 'BT': 'BTN',
                'BO': 'BOL', 'BA': 'BIH', 'BW': 'BWA', 'BR': 'BRA', 'BN': 'BRN', 'BG': 'BGR', 'BF': 'BFA', 'BI': 'BDI', 'KH': 'KHM', 'CM': 'CMR',
                'CA': 'CAN', 'CV': 'CPV', 'CF': 'CAF', 'TD': 'TCD', 'CL': 'CHL', 'CN': 'CHN', 'CO': 'COL', 'KM': 'COM', 'CG': 'COG', 'CD': 'COD',
                'CR': 'CRI', 'CI': 'CIV', 'HR': 'HRV', 'CU': 'CUB', 'CY': 'CYP', 'CZ': 'CZE', 'DK': 'DNK', 'DJ': 'DJI', 'DM': 'DMA', 'DO': 'DOM',
                'EC': 'ECU', 'EG': 'EGY', 'SV': 'SLV', 'GQ': 'GNQ', 'ER': 'ERI', 'EE': 'EST', 'SZ': 'SWZ', 'ET': 'ETH', 'FJ': 'FJI', 'FI': 'FIN',
                'FR': 'FRA', 'GA': 'GAB', 'GM': 'GMB', 'GE': 'GEO', 'DE': 'DEU', 'GH': 'GHA', 'GR': 'GRC', 'GD': 'GRD', 'GT': 'GTM', 'GN': 'GIN',
                'GW': 'GNB', 'GY': 'GUY', 'HT': 'HTI', 'HN': 'HND', 'HK': 'HKG', 'HU': 'HUN', 'IS': 'ISL', 'IN': 'IND', 'ID': 'IDN', 'IR': 'IRN',
                'IQ': 'IRQ', 'IE': 'IRL', 'IL': 'ISR', 'IT': 'ITA', 'JM': 'JAM', 'JP': 'JPN', 'JO': 'JOR', 'KZ': 'KAZ', 'KE': 'KEN', 'KI': 'KIR',
                'KP': 'PRK', 'KR': 'KOR', 'KW': 'KWT', 'KG': 'KGZ', 'LA': 'LAO', 'LV': 'LVA', 'LB': 'LBN', 'LS': 'LSO', 'LR': 'LBR', 'LY': 'LBY',
                'LI': 'LIE', 'LT': 'LTU', 'LU': 'LUX', 'MG': 'MDG', 'MW': 'MWI', 'MY': 'MYS', 'MV': 'MDV', 'ML': 'MLI', 'MT': 'MLT', 'MH': 'MHL',
                'MR': 'MRT', 'MU': 'MUS', 'MX': 'MEX', 'FM': 'FSM', 'MD': 'MDA', 'MC': 'MCO', 'MN': 'MNG', 'ME': 'MNE', 'MA': 'MAR', 'MZ': 'MOZ',
                'MM': 'MMR', 'NA': 'NAM', 'NR': 'NRU', 'NP': 'NPL', 'NL': 'NLD', 'NZ': 'NZL', 'NI': 'NIC', 'NE': 'NER', 'NG': 'NGA', 'MK': 'MKD',
                'NO': 'NOR', 'OM': 'OMN', 'PK': 'PAK', 'PW': 'PLW', 'PA': 'PAN', 'PG': 'PNG', 'PY': 'PRY', 'PE': 'PER', 'PH': 'PHL', 'PL': 'POL',
                'PT': 'PRT', 'QA': 'QAT', 'RO': 'ROU', 'RU': 'RUS', 'RW': 'RWA', 'KN': 'KNA', 'LC': 'LCA', 'VC': 'VCT', 'WS': 'WSM', 'SM': 'SMR',
                'ST': 'STP', 'SA': 'SAU', 'SN': 'SEN', 'RS': 'SRB', 'SC': 'SYC', 'SL': 'SLE', 'SG': 'SGP', 'SK': 'SVK', 'SI': 'SVN', 'SB': 'SLB',
                'SO': 'SOM', 'ZA': 'ZAF', 'SS': 'SSD', 'ES': 'ESP', 'LK': 'LKA', 'SD': 'SDN', 'SR': 'SUR', 'SE': 'SWE', 'CH': 'CHE', 'SY': 'SYR',
                'TW': 'TWN', 'TJ': 'TJK', 'TZ': 'TZA', 'TH': 'THA', 'TL': 'TLS', 'TG': 'TGO', 'TO': 'TON', 'TT': 'TTO', 'TN': 'TUN', 'TR': 'TUR',
                'TM': 'TKM', 'TV': 'TUV', 'UG': 'UGA', 'UA': 'UKR', 'AE': 'ARE', 'GB': 'GBR', 'US': 'USA', 'UY': 'URY', 'UZ': 'UZB', 'VU': 'VUT',
                'VE': 'VEN', 'VN': 'VNM', 'YE': 'YEM', 'ZM': 'ZMB', 'ZW': 'ZWE', 'XK': 'XKX'
            };
            const iso3 = iso2to3[iso] || iso;
            const countrySlug = country.toLowerCase().replace(/\s+/g, '-');

            const urls = {
                'economic_freedom': `https://www.heritage.org/index/country/${countrySlug}`,
                'gdp_per_capita': `https://data.worldbank.org/indicator/NY.GDP.PCAP.CD?locations=${iso}`,
                'life_expectancy': `https://data.worldbank.org/indicator/SP.DYN.LE00.IN?locations=${iso}`,
                'infant_mortality': `https://ourworldindata.org/grapher/infant-mortality?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`,
                'corruption_score': `https://www.transparency.org/en/cpi/2023/index/${iso3.toLowerCase()}`,
                'hdi': `https://hdr.undp.org/data-center/country-insights#/ranks`,
                'happiness_score': `https://ourworldindata.org/grapher/happiness-cantril-ladder?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`,
                'social_mobility_score': `https://worldpopulationreview.com/country-rankings/social-mobility-by-country`,
                'purchasing_power_index': `https://www.numbeo.com/cost-of-living/rankings_by_country.jsp?title=2025`,
                'pollution_index': `https://www.numbeo.com/pollution/rankings_by_country.jsp?title=2025`,
                'gini_index': `https://data.worldbank.org/indicator/SI.POV.GINI?locations=${iso}`,
                'democracy_score': `https://ourworldindata.org/grapher/democracy-index-eiu?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`,
                'crime_index': `https://www.numbeo.com/crime/rankings_by_country.jsp?title=2025`,
                'homicide_rate': `https://data.worldbank.org/indicator/VC.IHR.PSRC.P5?locations=${iso}`,
                'hale': `https://data.who.int/indicators/i/C64284D`,
                'mental_health_index': `https://ourworldindata.org/grapher/psychiatrists-working-in-the-mental-health-sector?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`,
                'education_index': `https://ourworldindata.org/grapher/education-index-from-the-human-development-index?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`,
                'gender_inequality_index': `https://ourworldindata.org/grapher/gender-inequality-index-from-the-human-development-report?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`,
                'poverty_rate': `https://ourworldindata.org/grapher/share-of-population-in-extreme-poverty?tab=table&time=latest&country=~${iso3}&tableSearch=${encodeURIComponent(country)}`
            };
            return urls[field] || '#';
        }

        function formatLinkedValue(country, field, val, decimals, isCurrency = false) {
            if (val === null || val === undefined) {
                return '<span style="color: var(--text-muted); font-style: italic;">N/A</span>';
            }
            let formatted = decimals === 0 ? Math.round(val).toLocaleString() : val.toFixed(decimals);
            if (isCurrency) {
                formatted = '$' + formatted;
            }
            const url = getDataUrl(country, field);
            return `<a href="${url}" target="_blank" rel="noopener" style="color: inherit; text-decoration: none; border-bottom: 1px dotted var(--text-muted);" title="View source data">${formatted}</a>`;
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            renderTable();
        }

        function filterTable() {
            renderTable();
        }

        function downloadCSV() {
            const headers = ['Country', 'Region', 'Economic Freedom', 'Gini Index', 'Democracy',
                           'GDP per Capita', 'Life Expectancy', 'Infant Mortality', 'Anti-Corruption',
                           'HDI', 'Happiness', 'Social Mobility', 'Purchasing Power', 'Pollution', 'Crime', 'Homicide Rate',
                           'Healthy Life Expectancy', 'Mental Health Access', 'Education Index', 'Gender Inequality', 'Poverty Rate'];

            const rows = allData.map(c => [
                c.name,
                c.region || '',
                c.economic_freedom ?? '',
                c.gini_index ?? '',
                c.democracy_score ?? '',
                c.gdp_per_capita ?? '',
                c.life_expectancy ?? '',
                c.infant_mortality ?? '',
                c.corruption_score ?? '',
                c.hdi ?? '',
                c.happiness_score ?? '',
                c.social_mobility_score ?? '',
                c.purchasing_power_index ?? '',
                c.pollution_index ?? '',
                c.crime_index ?? '',
                c.homicide_rate ?? '',
                c.hale ?? '',
                c.mental_health_index ?? '',
                c.education_index ?? '',
                c.gender_inequality_index ?? '',
                c.poverty_rate ?? ''
            ]);

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'economic_freedom_data.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function getVerdictText(summary) {
            if (summary.verdict === 'supports') {
                return `The data <strong style="color: var(--success);">SUPPORTS</strong> the claim that economic freedom correlates with better quality-of-life outcomes. ${summary.positive_correlations} out of ${summary.total_indices} indices show statistically significant positive correlations.`;
            } else if (summary.verdict === 'contradicts') {
                return `The data <strong style="color: var(--danger);">CONTRADICTS</strong> the claim that economic freedom correlates with better quality-of-life outcomes.`;
            } else {
                return `The data shows <strong style="color: var(--warning);">MIXED</strong> results regarding economic freedom and quality-of-life outcomes.`;
            }
        }

        function renderDataSources() {
            const sources = [
                {
                    name: "Economic Freedom Index",
                    org: "Heritage Foundation",
                    year: 2024,
                    desc: "Measures economic freedom based on rule of law, government size, regulatory efficiency, and open markets.",
                    url: "https://www.heritage.org/index/",
                    indices: ["Economic Freedom Score"]
                },
                {
                    name: "World Development Indicators",
                    org: "World Bank",
                    year: 2022,
                    desc: "Comprehensive development data including GDP per capita, life expectancy, and infant mortality rates.",
                    url: "https://data.worldbank.org/indicator",
                    indices: ["GDP per Capita", "Life Expectancy", "Infant Mortality"]
                },
                {
                    name: "Corruption Perceptions Index",
                    org: "Transparency International",
                    year: 2023,
                    desc: "Ranks countries by perceived levels of public sector corruption based on expert assessments.",
                    url: "https://www.transparency.org/en/cpi/2023",
                    indices: ["Anti-Corruption Score"]
                },
                {
                    name: "Human Development Index",
                    org: "United Nations Development Programme",
                    year: 2022,
                    desc: "Composite index measuring life expectancy, education, and per capita income indicators.",
                    url: "https://hdr.undp.org/data-center/human-development-index",
                    indices: ["HDI"]
                },
                {
                    name: "World Happiness Report",
                    org: "Gallup / UN Sustainable Development Solutions Network",
                    year: 2024,
                    desc: "Measures subjective well-being based on life evaluations, emotions, and social support.",
                    url: "https://worldhappiness.report/",
                    indices: ["Happiness Score"]
                },
                {
                    name: "Global Social Mobility Index",
                    org: "World Economic Forum",
                    year: 2020,
                    desc: "Measures ability of individuals to move up the socioeconomic ladder regardless of background.",
                    url: "https://www.weforum.org/publications/global-social-mobility-index-2020/",
                    indices: ["Social Mobility Score"]
                },
                {
                    name: "Cost of Living Index",
                    org: "Numbeo",
                    year: 2025,
                    desc: "Measures relative purchasing power based on consumer goods prices, rent, and local salaries.",
                    url: "https://www.numbeo.com/cost-of-living/rankings_by_country.jsp",
                    indices: ["Purchasing Power Index"]
                },
                {
                    name: "Pollution Index",
                    org: "Numbeo",
                    year: 2025,
                    desc: "Measures pollution levels based on air quality, water quality, waste management, and other environmental factors.",
                    url: "https://www.numbeo.com/pollution/rankings_by_country.jsp",
                    indices: ["Pollution Index"]
                },
                {
                    name: "Democracy Index",
                    org: "Economist Intelligence Unit",
                    year: 2023,
                    desc: "Measures the state of democracy based on electoral process, civil liberties, functioning of government, political participation, and political culture.",
                    url: "https://ourworldindata.org/grapher/democracy-index-eiu",
                    indices: ["Democracy Score"]
                },
                {
                    name: "Crime Index",
                    org: "Numbeo",
                    year: 2025,
                    desc: "Measures overall crime levels based on surveys about safety, including perception of crime, safety walking alone, and concerns about specific crimes.",
                    url: "https://www.numbeo.com/crime/rankings_by_country.jsp",
                    indices: ["Crime Index"]
                },
                {
                    name: "Intentional Homicide Statistics",
                    org: "UNODC (via World Bank)",
                    year: 2022,
                    desc: "Intentional homicides per 100,000 people. Data from UN Office on Drugs and Crime, accessed via World Bank API.",
                    url: "https://data.worldbank.org/indicator/VC.IHR.PSRC.P5",
                    indices: ["Homicide Rate"]
                },
                {
                    name: "Healthy Life Expectancy (HALE)",
                    org: "World Health Organization",
                    year: 2021,
                    desc: "Average number of years a person can expect to live in full health, accounting for years lost due to disease and disability.",
                    url: "https://data.who.int/indicators/i/C64284D",
                    indices: ["HALE"]
                },
                {
                    name: "Mental Health Atlas",
                    org: "World Health Organization",
                    year: 2021,
                    desc: "Psychiatrists working in the mental health sector per 100,000 population. Measures access to mental health services.",
                    url: "https://ourworldindata.org/grapher/psychiatrists-working-in-the-mental-health-sector",
                    indices: ["Mental Health Access"]
                }
            ];

            const linkIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /></svg>`;

            return sources.map(s => `
                <div class="source-card">
                    <h4>${s.name}</h4>
                    <div class="source-org">${s.org}</div>
                    <span class="source-year">${s.year}</span>
                    <div class="source-desc">${s.desc}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">
                        <strong>Used for:</strong> ${s.indices.join(", ")}
                    </div>
                    <a href="${s.url}" target="_blank" rel="noopener noreferrer">
                        View source ${linkIcon}
                    </a>
                </div>
            `).join('');
        }

        let scatterChart = null;

        function initScatterChart() {
            const ctx = document.getElementById('scatterChart').getContext('2d');
            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 35,
                            right: 20
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.country}: (${context.raw.x}, ${context.raw.y})`;
                                }
                            }
                        },
                        legend: {
                            display: true
                        },
                        annotation: {
                            clip: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            grace: 0,
                            title: {
                                display: true,
                                text: 'Economic Freedom Score'
                            },
                            ticks: {
                                autoSkip: false
                            }
                        },
                        y: {
                            type: 'linear',
                            grace: 0,
                            title: {
                                display: true,
                                text: ''
                            },
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                }
            });
            updateChart();
        }

        function updateCountryDropdown() {
            const select = document.getElementById('indexSelect');
            const countrySelect = document.getElementById('countrySelect');
            const xAxisSelect = document.getElementById('xAxisSelect');
            if (!select || !countrySelect || !xAxisSelect) return;

            const selectedId = select.value;
            const selectedXAxis = xAxisSelect.value || 'economic_freedom';
            const currentCountry = countrySelect.value;
            const data = window.analysisData;

            // X-axis key mapping
            const xAxisKeyMap = {
                'economic_freedom': 'economic_freedom',
                'democracy_score': 'democracy_score',
                'gini_index': 'gini_index'
            };
            const xKey = xAxisKeyMap[selectedXAxis];

            // Y-axis key mapping
            const yKeyMap = {
                'GDP_Per_Capita': 'gdp_per_capita',
                'Life_Expectancy': 'life_expectancy',
                'Infant_Mortality': 'infant_mortality',
                'Corruption_Score': 'corruption_score',
                'HDI': 'hdi',
                'Happiness_Score': 'happiness_score',
                'Social_Mobility_Score': 'social_mobility_score',
                'Purchasing_Power_Index': 'purchasing_power_index',
                'Pollution_Index': 'pollution_index',
                'Crime_Index': 'crime_index',
                'Homicide_Rate': 'homicide_rate',
                'HALE': 'hale',
                'Mental_Health_Index': 'mental_health_index',
                'Education_Index': 'education_index',
                'Gender_Inequality_Index': 'gender_inequality_index',
                'Poverty_Rate': 'poverty_rate'
            };
            const yKey = yKeyMap[selectedId];

            // Filter countries that have data for both X and Y axes
            const validCountries = data.countries
                .filter(c => c[xKey] != null && c[yKey] != null)
                .sort((a, b) => a.name.localeCompare(b.name));

            // Rebuild dropdown
            countrySelect.innerHTML = '<option value="">None</option>' +
                validCountries.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            // Restore selection if still valid
            if (currentCountry && validCountries.some(c => c.name === currentCountry)) {
                countrySelect.value = currentCountry;
            }
        }

        function updateChart() {
            const select = document.getElementById('indexSelect');
            const countrySelect = document.getElementById('countrySelect');
            const xAxisSelect = document.getElementById('xAxisSelect');

            // Update country dropdown to show only countries with data for current axes
            updateCountryDropdown();

            const selectedId = select.value;
            const selectedCountry = countrySelect ? countrySelect.value : '';
            const selectedXAxis = xAxisSelect ? xAxisSelect.value : 'economic_freedom';
            const data = window.analysisData;

            const correlation = data.correlations.find(c => c.id === selectedId);
            if (!correlation) return;

            // X-axis configuration
            const xAxisConfig = {
                'economic_freedom': { key: 'economic_freedom', label: 'Economic Freedom Score', invert: false },
                'democracy_score': { key: 'democracy_score', label: 'Democracy Score', invert: false },
                'gini_index': { key: 'gini_index', label: 'Equality (100 - Gini)', invert: true }
            };
            const xConfig = xAxisConfig[selectedXAxis];

            // Y-axis key mapping
            const yKeyMap = {
                'GDP_Per_Capita': 'gdp_per_capita',
                'Life_Expectancy': 'life_expectancy',
                'Infant_Mortality': 'infant_mortality',
                'Corruption_Score': 'corruption_score',
                'HDI': 'hdi',
                'Happiness_Score': 'happiness_score',
                'Social_Mobility_Score': 'social_mobility_score',
                'Purchasing_Power_Index': 'purchasing_power_index',
                'Pollution_Index': 'pollution_index',
                'Crime_Index': 'crime_index',
                'Homicide_Rate': 'homicide_rate',
                'HALE': 'hale',
                'Mental_Health_Index': 'mental_health_index',
                'Education_Index': 'education_index',
                'Gender_Inequality_Index': 'gender_inequality_index',
                'Poverty_Rate': 'poverty_rate'
            };
            const yKey = yKeyMap[selectedId];

            // Build scatter points from country data
            const scatterPoints = [];
            data.countries.forEach(country => {
                let xVal = country[xConfig.key];
                const yVal = country[yKey];
                if (xVal != null && yVal != null) {
                    // For Gini, invert to make higher = more equal
                    if (xConfig.invert) {
                        xVal = 100 - xVal;
                    }
                    scatterPoints.push({
                        country: country.name,
                        x: Math.round(xVal * 100) / 100,
                        y: Math.round(yVal * 100) / 100
                    });
                }
            });

            if (scatterPoints.length < 3) {
                scatterChart.data.datasets = [];
                scatterChart.update();
                document.getElementById('chartInterpretation').innerHTML = 'Not enough data for this combination.';
                return;
            }

            // Calculate correlation and trend line
            const xVals = scatterPoints.map(p => p.x);
            const yVals = scatterPoints.map(p => p.y);
            const n = xVals.length;
            const sumX = xVals.reduce((a, b) => a + b, 0);
            const sumY = yVals.reduce((a, b) => a + b, 0);
            const sumXY = xVals.reduce((acc, x, i) => acc + x * yVals[i], 0);
            const sumX2 = xVals.reduce((acc, x) => acc + x * x, 0);
            const sumY2 = yVals.reduce((acc, y) => acc + y * y, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // Pearson correlation
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            const r = denominator !== 0 ? numerator / denominator : 0;

            // Check if user manually changed the country
            if (selectedCountry && userCountry && selectedCountry.toLowerCase() !== userCountry.toLowerCase()) {
                isUserCountry = false;
            } else if (selectedCountry && userCountry && selectedCountry.toLowerCase() === userCountry.toLowerCase()) {
                isUserCountry = true;
            }

            // Generate trend line points
            const xMin = Math.min(...xVals);
            const xMax = Math.max(...xVals);
            const trendPoints = [];
            for (let x = xMin; x <= xMax; x += (xMax - xMin) / 50) {
                trendPoints.push({ x: x, y: slope * x + intercept });
            }

            // Determine if correlation is positive for coloring
            // For metrics where lower is better (Infant Mortality, Pollution), effective correlation is inverted
            const higherBetter = correlation.higher_better !== false;
            const effectiveR = higherBetter ? r : -r;
            const isPositive = effectiveR > 0;
            const pointColor = isPositive ? 'rgba(22, 163, 74, 0.6)' : 'rgba(220, 38, 38, 0.6)';

            // Separate highlighted country from others
            const highlightedPoint = selectedCountry
                ? scatterPoints.find(p => p.country.toLowerCase() === selectedCountry.toLowerCase())
                : null;
            const otherPoints = selectedCountry
                ? scatterPoints.filter(p => p.country.toLowerCase() !== selectedCountry.toLowerCase())
                : scatterPoints;

            const datasets = [
                {
                    label: 'Countries',
                    data: otherPoints,
                    backgroundColor: pointColor,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    order: 2
                },
                {
                    label: `Trend (r = ${r.toFixed(3)})`,
                    data: trendPoints,
                    type: 'line',
                    borderColor: 'rgba(239, 68, 68, 0.8)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    order: 3
                }
            ];

            // Add highlighted country as separate dataset
            if (highlightedPoint) {
                const labelText = isUserCountry ? `${selectedCountry} (You're here)` : selectedCountry;
                datasets.push({
                    label: labelText,
                    data: [highlightedPoint],
                    backgroundColor: 'rgba(37, 99, 235, 1)',
                    borderColor: 'rgba(30, 64, 175, 1)',
                    borderWidth: 2,
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    pointStyle: 'circle',
                    order: 0
                });
            }

            scatterChart.data.datasets = datasets;
            scatterChart.options.scales.x.title.text = xConfig.label;
            scatterChart.options.scales.y.title.text = `${correlation.name} (n=${n})`;

            // Calculate actual data bounds with padding
            const yDataMin = Math.min(...yVals);
            const yDataMax = Math.max(...yVals);
            const xPadding = (xMax - xMin) * 0.07;
            const yPadding = (yDataMax - yDataMin) * 0.07;
            scatterChart.options.scales.x.min = xMin - xPadding;
            scatterChart.options.scales.x.max = xMax + xPadding;
            scatterChart.options.scales.x.bounds = 'data';
            scatterChart.options.scales.y.min = yDataMin - yPadding;
            scatterChart.options.scales.y.max = yDataMax + yPadding;
            scatterChart.options.scales.y.bounds = 'data';

            // Update annotation for highlighted country
            if (highlightedPoint && isUserCountry) {
                const yRange = yDataMax - yDataMin;
                const pointYPercent = (highlightedPoint.y - yDataMin) / yRange;
                const yAdjust = pointYPercent > 0.7 ? 30 : -30;

                scatterChart.options.plugins.annotation = {
                    clip: false,
                    annotations: {
                        label1: {
                            type: 'label',
                            xValue: highlightedPoint.x,
                            yValue: highlightedPoint.y,
                            content: ["You're here"],
                            backgroundColor: 'rgba(37, 99, 235, 0.9)',
                            color: 'white',
                            font: { size: 11, weight: 'bold' },
                            padding: { top: 4, bottom: 4, left: 8, right: 8 },
                            borderRadius: 4,
                            yAdjust: yAdjust
                        }
                    }
                };
            } else {
                scatterChart.options.plugins.annotation = { annotations: {} };
            }

            scatterChart.update();

            // Update interpretation box
            const interpBox = document.getElementById('chartInterpretation');
            const favorable = isPositive;
            const rawCorrelationPositive = r > 0;
            interpBox.className = `interpretation-box ${favorable ? 'positive' : 'negative'}`;

            // X-axis name for interpretation
            const xAxisNames = {
                'economic_freedom': 'economic freedom',
                'democracy_score': 'democracy',
                'gini_index': 'equality'
            };
            const xAxisName = xAxisNames[selectedXAxis];

            if (Math.abs(r) > 0.1 && n > 10) {
                const direction = rawCorrelationPositive ? 'higher' : 'lower';
                const outcome = favorable ? 'better' : 'worse';
                let countryInfo = '';
                if (highlightedPoint) {
                    countryInfo = `<br><br><strong>${selectedCountry}:</strong> ${xConfig.label}: ${highlightedPoint.x}, ${correlation.name}: ${highlightedPoint.y}`;
                }
                const verdict = favorable
                    ? `<br><br><strong style="color: var(--success);">Does ${xAxisName} correlate with better outcomes? Yes.</strong>`
                    : `<br><br><strong style="color: var(--danger);">Does ${xAxisName} correlate with better outcomes? No, not for this metric.</strong>`;
                interpBox.innerHTML = `
                    Countries with higher ${xAxisName} tend to have
                    <strong>${direction}</strong> ${correlation.name.toLowerCase()}, which represents
                    <strong>${outcome}</strong> outcomes (r = ${r.toFixed(2)}, n = ${n}).${countryInfo}${verdict}
                `;
            } else {
                interpBox.innerHTML = `
                    No strong relationship was found
                    between ${xAxisName} and ${correlation.name.toLowerCase()} (r = ${r.toFixed(2)}, n = ${n}).
                    <br><br><strong style="color: var(--text-muted);">Does ${xAxisName} correlate with better outcomes? The data doesn't show a clear pattern.</strong>
                `;
            }
        }

        function flipCard(container, event) {
            event.stopPropagation();
            container.classList.toggle('flipped');
        }

        // Generate clear, explanatory conclusion text for card back
        function generateConclusion(metric, winner, winnerClass, loser, loserClass, isTie) {
            const higherIsBetter = metric.higher_better !== false;

            // Custom explanations for each metric
            const explanations = {
                'GDP_Per_Capita': {
                    outcome: 'wealthier citizens',
                    detail: 'Citizens in countries with more ${winner} tend to earn more money.'
                },
                'Life_Expectancy': {
                    outcome: 'longer lifespans',
                    detail: 'People tend to live longer in countries with more ${winner}.'
                },
                'Infant_Mortality': {
                    outcome: 'lower infant mortality',
                    detail: 'Fewer babies die in their first year in countries with more ${winner}.'
                },
                'Corruption_Score': {
                    outcome: 'less government corruption',
                    detail: 'Governments tend to be less corrupt in countries with more ${winner}.'
                },
                'HDI': {
                    outcome: 'higher human development',
                    detail: 'Countries with more ${winner} score better on health, education, and living standards.'
                },
                'Happiness_Score': {
                    outcome: 'happier people',
                    detail: 'People report higher life satisfaction in countries with more ${winner}.'
                },
                'Social_Mobility_Score': {
                    outcome: 'better social mobility',
                    detail: 'It\'s easier to climb the economic ladder in countries with more ${winner}.'
                },
                'Purchasing_Power_Index': {
                    outcome: 'stronger purchasing power',
                    detail: 'Your salary buys more goods and services in countries with more ${winner}.'
                },
                'Pollution_Index': {
                    outcome: 'cleaner environments',
                    detail: 'Air and water tend to be less polluted in countries with more ${winner}.'
                },
                'Crime_Index': {
                    outcome: 'lower crime rates',
                    detail: 'People are less likely to be victims of crime in countries with more ${winner}.'
                },
                'Homicide_Rate': {
                    outcome: 'lower murder rates',
                    detail: 'Fewer people are murdered per capita in countries with more ${winner}.'
                },
                'HALE': {
                    outcome: 'more healthy years of life',
                    detail: 'People spend more years in good health in countries with more ${winner}.'
                },
                'Mental_Health_Index': {
                    outcome: 'better mental health access',
                    detail: 'There are more mental health professionals per capita in countries with more ${winner}.'
                },
                'Education_Index': {
                    outcome: 'better education',
                    detail: 'People have more years of schooling and better education quality with more ${winner}.'
                },
                'Gender_Inequality_Index': {
                    outcome: 'more gender equality',
                    detail: 'Women have more equal opportunities in health, education, and work in countries with more ${winner}.'
                },
                'Poverty_Rate': {
                    outcome: 'less extreme poverty',
                    detail: 'Fewer people live on less than $2.15 per day in countries with more ${winner}.'
                }
            };

            const exp = explanations[metric.metric_id] || {
                outcome: 'better outcomes',
                tieOutcome: 'better outcomes'
            };

            if (isTie) {
                // For ties, both top predictors are essentially "winners"
                const tieTemplates = [
                    `It's a tie! Both <span class="winner-name ${winnerClass}">${winner}</span> and <span class="winner-name ${loserClass}">${loser}</span> are equally linked to ${exp.outcome}.`,
                    `Too close to call. <span class="winner-name ${winnerClass}">${winner}</span> and <span class="winner-name ${loserClass}">${loser}</span> both correlate with ${exp.outcome}.`,
                    `A draw. Countries with more <span class="winner-name ${winnerClass}">${winner}</span> or <span class="winner-name ${loserClass}">${loser}</span> tend to have ${exp.outcome}.`
                ];
                return tieTemplates[metric.metric.length % tieTemplates.length];
            }

            const detail = exp.detail.replace(/\$\{winner\}/g, winner.toLowerCase());

            // Varied openers
            const openers = [
                `<span class="winner-name ${winnerClass}">${winner}</span> wins.`,
                `Point for <span class="winner-name ${winnerClass}">${winner}</span>.`,
                `<span class="winner-name ${winnerClass}">${winner}</span> takes this one.`,
                `This goes to <span class="winner-name ${winnerClass}">${winner}</span>.`
            ];

            const opener = openers[metric.metric.length % openers.length];
            return `${opener} ${detail}`;
        }

        function renderComparison() {
            const data = window.analysisData;
            const comparison = data.comparison;

            if (!comparison) return;

            const container = document.getElementById('comparisonSection');

            // Define metric categories
            const categories = {
                'Health & Longevity': ['Life_Expectancy', 'HALE', 'Infant_Mortality', 'Mental_Health_Index'],
                'Wealth & Opportunity': ['GDP_Per_Capita', 'Purchasing_Power_Index', 'Social_Mobility_Score', 'Poverty_Rate'],
                'Safety & Environment': ['Crime_Index', 'Homicide_Rate', 'Pollution_Index', 'Corruption_Score'],
                'Development & Well-being': ['HDI', 'Happiness_Score', 'Education_Index', 'Gender_Inequality_Index']
            };

            // Group metrics by category
            const groupedMetrics = {};
            for (const [category, metricIds] of Object.entries(categories)) {
                groupedMetrics[category] = comparison.metrics.filter(m => metricIds.includes(m.metric_id));
            }

            // Summary cards
            let html = `
                <div class="comparison-container">
                    <div class="comparison-grid">
            `;

            // Category icons
            const categoryIcons = {
                'Health & Longevity': 'â¤ï¸',
                'Wealth & Opportunity': 'ð°',
                'Safety & Environment': 'ð¡ï¸',
                'Development & Well-being': 'â­'
            };

            // Render metrics grouped by category
            for (const [category, metrics] of Object.entries(groupedMetrics)) {
                if (metrics.length === 0) continue;

                const icon = categoryIcons[category] || '';
                html += `<div class="category-header">${icon} ${category}</div>`;

                metrics.forEach(m => {
                const efCorr = m.economic_freedom.effective;
                const eqCorr = m.equality.effective;
                const demCorr = m.democracy ? m.democracy.effective : null;
                const efN = m.economic_freedom.n || 0;
                const eqN = m.equality.n || 0;
                const demN = m.democracy ? m.democracy.n : 0;
                const eqRawCorr = m.equality.correlation; // Raw Gini correlation

                // Create array of bars and sort by correlation (largest to smallest)
                const bars = [
                    { label: 'Economic Freedom', cssClass: 'freedom', value: efCorr, n: efN, color: 'var(--success)', fillClass: 'comparison-bar-fill-green', rawCorr: m.economic_freedom.correlation },
                    { label: 'Equality', cssClass: 'equality', value: eqCorr, n: eqN, color: 'var(--danger)', fillClass: 'comparison-bar-fill-red', rawCorr: eqRawCorr },
                    { label: 'Democracy', cssClass: 'democracy', value: demCorr, n: demN, color: '#3b82f6', fillClass: 'comparison-bar-fill-blue', rawCorr: m.democracy?.correlation }
                ].sort((a, b) => (b.value || 0) - (a.value || 0));

                const invertedLabel = !m.higher_better ? ' <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;">(inverted)</span>' : '';

                // Determine winner and second place for conclusion
                const winner = bars[0].label;
                const winnerCss = bars[0].cssClass;
                const isTie = m.winner === 'tie';
                // For ties, show the two top predictors; otherwise show winner vs last place
                const secondIdx = isTie ? 1 : bars.length - 1;
                const secondPredictor = bars[secondIdx].label;
                const secondCss = bars[secondIdx].cssClass;
                const conclusion = generateConclusion(m, winner, winnerCss, secondPredictor, secondCss, isTie);

                html += `
                    <div class="card-flip-container" onclick="flipCard(this, event)">
                        <div class="card-flip">
                            <span class="card-info-hint">i</span>
                            <div class="card-front comparison-row">
                                <div class="comparison-metric">
                                    <strong>${m.metric}</strong>${invertedLabel}
                                </div>
                `;

                bars.forEach(bar => {
                    const width = bar.value ? Math.round(bar.value * 100) : 0;
                    const valueText = bar.value !== null ? `${bar.value.toFixed(2)} (n=${bar.n})` : 'N/A';
                    html += `
                        <div class="comparison-bar-col" data-label="${bar.cssClass === 'freedom' ? 'Freedom' : bar.label}">
                            <div class="comparison-bar-wrapper">
                                <div class="comparison-bar-track">
                                    <div class="${bar.fillClass}" style="width: ${width}%;"></div>
                                </div>
                                <span class="comparison-value" style="color: ${bar.color};">${valueText}</span>
                            </div>
                        </div>
                    `;
                });

                html += `
                            </div>
                            <div class="card-back">
                                <div class="card-back-text">${conclusion}</div>
                            </div>
                        </div>
                    </div>
                `;
                });
            }

            const efClearWins = comparison.economic_freedom_clear_wins || 0;
            const demClearWins = comparison.democracy_clear_wins || 0;
            const eqClearWins = comparison.equality_clear_wins || 0;
            const ties = comparison.ties || 0;

            // Build dynamic results text
            const winners = [];
            if (efClearWins > 0) winners.push(`Economic Freedom clearly wins <strong>${efClearWins}</strong> metric${efClearWins > 1 ? 's' : ''}`);
            if (demClearWins > 0) winners.push(`Democracy clearly wins <strong>${demClearWins}</strong> metric${demClearWins > 1 ? 's' : ''}`);
            if (eqClearWins > 0) winners.push(`Equality clearly wins <strong>${eqClearWins}</strong> metric${eqClearWins > 1 ? 's' : ''}`);

            let resultsText = winners.length > 0 ? winners.join('. ') + '.' : 'No clear winners.';

            if (ties > 0) {
                // Determine who's typically tied by looking at top performers in tie metrics
                const tieMetrics = comparison.metrics.filter(m => m.winner === 'tie');
                if (tieMetrics.length > 0) {
                    // Find the top 2 performers across tie metrics
                    const avgScores = { 'Freedom': 0, 'Democracy': 0, 'Equality': 0 };
                    tieMetrics.forEach(m => {
                        avgScores['Freedom'] += m.economic_freedom?.effective || 0;
                        avgScores['Democracy'] += m.democracy?.effective || 0;
                        avgScores['Equality'] += m.equality?.effective || 0;
                    });
                    const sorted = Object.entries(avgScores).sort((a, b) => b[1] - a[1]);
                    const tiedParties = sorted.slice(0, 2).map(x => x[0]).join(' and ');
                    resultsText += ` <strong>${ties}</strong> metric${ties > 1 ? 's are a tie' : ' is a tie'} between ${tiedParties}.`;
                }
            }

            // Calculate league points (3 for clear win, 1 for tie)
            // First, determine who participates in ties
            const tieMetrics = comparison.metrics.filter(m => m.winner === 'tie');
            let freedomTies = 0, democracyTies = 0, equalityTies = 0;

            tieMetrics.forEach(m => {
                // Top 2 performers in each tie get a point
                const metricScores = [
                    { name: 'Freedom', score: m.economic_freedom?.effective || 0 },
                    { name: 'Democracy', score: m.democracy?.effective || 0 },
                    { name: 'Equality', score: m.equality?.effective || 0 }
                ].sort((a, b) => b.score - a.score);

                const top2 = metricScores.slice(0, 2).map(x => x.name);
                if (top2.includes('Freedom')) freedomTies++;
                if (top2.includes('Democracy')) democracyTies++;
                if (top2.includes('Equality')) equalityTies++;
            });

            const points = [
                { name: 'Economic Freedom', pts: efClearWins * 3 + freedomTies },
                { name: 'Democracy', pts: demClearWins * 3 + democracyTies },
                { name: 'Equality', pts: eqClearWins * 3 + equalityTies }
            ].sort((a, b) => b.pts - a.pts);

            const [first, second, third] = points;
            let conclusion = '';

            if (first.pts > second.pts) {
                const margin = first.pts - second.pts;
                if (margin >= 5) {
                    conclusion = `<strong>${first.name} is the clear winner.</strong>`;
                } else {
                    conclusion = `<strong>${first.name} comes out ahead.</strong>`;
                }
            } else if (first.pts === second.pts) {
                conclusion = `<strong>${first.name} and ${second.name} both lead.</strong>`;
            }

            // Less than 3 points = clear loser
            if (third.pts < 3) {
                const loserAnalogies = [
                    `${third.name} is the Washington Generals of economic theories.`,
                    `${third.name} is the Wile E. Coyote of economic theories.`,
                    `${third.name} is the Charlie Brown of economic theories.`,
                    `${third.name} is the Tom (chasing Jerry) of economic theories.`,
                    `${third.name} is the Blockbuster to Freedom's Netflix.`,
                    `${third.name} is the Nokia of economic theories.`,
                    `${third.name} pulled a Titanic.`,
                    `${third.name} is the Myspace of economic theories.`,
                    `${third.name} is the Internet Explorer of economic theories.`,
                    `${third.name} is the Kodak of economic theories.`,
                    `${third.name} is the Blackberry of economic theories.`,
                    `${third.name} is the Yahoo to Freedom's Google.`,
                    `${third.name} is the Sears to Freedom's Amazon.`,
                    `${third.name} is the Goliath of economic theories.`,
                    `${third.name} is the Hindenburg of economic theories.`,
                    `${third.name} is the Monstars to Freedom's Michael Jordan.`,
                    `${third.name} is the Empire to Freedom's Rebellion.`,
                    `${third.name} is the Voldemort of economic theories.`,
                    `${third.name} is the Hare to Freedom's Tortoise.`,
                    `${third.name} is the Napoleon at Waterloo of economics.`,
                    `${third.name} is the Dodo bird of economic theories.`,
                    `${third.name} is the Clippy of economic theories.`,
                    `${third.name} is the Betamax of economic theories.`,
                    `${third.name} is the Zune to Freedom's iPod.`,
                    `${third.name} got Pluto'd (demoted).`,
                    `${third.name} went full Homer Simpson.`,
                    `${third.name} went full Ned Stark.`,
                    `${third.name} went full Game of Thrones Season 8.`,
                    `${third.name} went full Al Bundy.`,
                    `${third.name} pulled a George Costanza.`,
                    `${third.name} is as self-destructive as Bojack Horseman.`,
                    `${third.name} has the success rate of Michael Scott's relationships.`,
                    `${third.name} is as effective as a Michael Scott leadership seminar.`
                ];
                conclusion += ' ' + loserAnalogies[Math.floor(Math.random() * loserAnalogies.length)];
            } else if (third.pts <= 8) {
                // 3-8 points = subtle loser (put up a fight but still lost)
                const subtleLoserAnalogies = [
                    `Like Al Bundy, ${third.name} could have done better.`,
                    `${third.name} showed up, but so did the other two.`,
                    `${third.name} brought a knife to a gunfight. A nice knife, though.`,
                    `${third.name} finished the race. Just... not first. Or second.`,
                    `${third.name} is the bronze medal of economic theories.`,
                    `${third.name} tried. The data noticed.`,
                    `${third.name} peaked early, like a child actor.`,
                    `Don't worry ${third.name}, at least you tried.`,
                    `${third.name}: close, but no cigar.`,
                    `${third.name} gets a participation trophy.`,
                    `${third.name} is the Ringo of this competition.`,
                    `${third.name} is giving strong "almost made the playoffs" energy.`,
                    `${third.name}: not bad, just... not good.`,
                    `${third.name} tried harder than the results suggest. Maybe.`,
                    `${third.name} came in third, but at least it was a podium finish. Oh wait.`,
                    `${third.name} is the underdog story that stayed under.`,
                    `${third.name} gets points for effort. Not many, but some.`,
                    `Good effort champ. We're proud of you, ${third.name}.`,
                    `${third.name} is like bringing homemade cookies to a bake-off. Sweet, but outclassed.`,
                    `${third.name} gave it the old college try. Community college.`,
                    `${third.name} played a good game, just not good enough.`,
                    `${third.name} is the opening band of economic theories.`,
                    `${third.name} made it to the dance, just not the spotlight.`,
                    `${third.name}: A for effort, C for results.`,
                    `${third.name} put up a fight. The fight lost.`,
                    `Maybe next year, ${third.name}.`,
                    `${third.name} brought its A-game. The others brought their A+-game.`,
                    `${third.name} is the honorable mention of economic theories.`,
                    `${third.name} ran a good race, just in the wrong lane.`,
                    `${third.name}: not embarrassing, just... third.`
                ];
                conclusion += ' ' + subtleLoserAnalogies[Math.floor(Math.random() * subtleLoserAnalogies.length)];
            }

            // Calculate total scores (wins + ties) for the chart
            const totalMetrics = comparison.metrics.length;
            const freedomTotal = efClearWins + freedomTies;
            const democracyTotal = demClearWins + democracyTies;
            const equalityTotal = eqClearWins + equalityTies;
            const maxTotal = Math.max(freedomTotal, democracyTotal, equalityTotal, 1);

            // Determine winner for crown
            const scores = [
                { name: 'Economic Freedom', total: freedomTotal, color: 'var(--success)' },
                { name: 'Democracy', total: democracyTotal, color: '#3b82f6' },
                { name: 'Equality', total: equalityTotal, color: 'var(--danger)' }
            ].sort((a, b) => b.total - a.total);

            const winner = scores[0].name;
            const isTie = scores[0].total === scores[1].total;

            html += `
                    </div>
                </div>
                <div class="comparison-results-chart" id="comparisonResults">
                    <div class="results-chart-title"><strong>Results</strong> (out of ${totalMetrics} metrics)</div>
                    <div class="results-bars">
                        <div class="results-bar-col">
                            <div class="results-bar-container">
                                ${winner === 'Economic Freedom' && !isTie ? '<span class="crown">ð</span>' : ''}
                                <div class="results-bar-fill" style="height: ${(freedomTotal / maxTotal) * 100}%; background: var(--success);"></div>
                                <div class="results-bar-breakdown">
                                    <div class="results-bar-total">${freedomTotal}</div>
                                    <div class="results-bar-detail">${efClearWins} wins<br>${freedomTies} ties</div>
                                </div>
                            </div>
                            <span class="results-bar-label" style="color: var(--success);">Freedom</span>
                        </div>
                        <div class="results-bar-col">
                            <div class="results-bar-container">
                                ${winner === 'Democracy' && !isTie ? '<span class="crown">ð</span>' : ''}
                                <div class="results-bar-fill" style="height: ${(democracyTotal / maxTotal) * 100}%; background: #3b82f6;"></div>
                                <div class="results-bar-breakdown">
                                    <div class="results-bar-total">${democracyTotal}</div>
                                    <div class="results-bar-detail">${demClearWins} wins<br>${democracyTies} ties</div>
                                </div>
                            </div>
                            <span class="results-bar-label" style="color: #3b82f6;">Democracy</span>
                        </div>
                        <div class="results-bar-col">
                            <div class="results-bar-container">
                                ${winner === 'Equality' && !isTie ? '<span class="crown">ð</span>' : ''}
                                <div class="results-bar-fill" style="height: ${(equalityTotal / maxTotal) * 100}%; background: var(--danger);"></div>
                                <div class="results-bar-breakdown">
                                    <div class="results-bar-total">${equalityTotal}</div>
                                    <div class="results-bar-detail">${eqClearWins} wins<br>${equalityTies} ties</div>
                                </div>
                            </div>
                            <span class="results-bar-label" style="color: var(--danger);">Equality</span>
                        </div>
                    </div>
                </div>
                <div class="comparison-verdict" id="comparisonVerdict">
                    ${conclusion}
                </div>
            `;

            container.innerHTML = html;

            // Initialize skip button now that elements exist
            if (typeof initSkipToVerdict === 'function') {
                initSkipToVerdict();
            }
        }

        // Contact form - send to Telegram
        async function sendContactMessage(event) {
            event.preventDefault();

            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const message = document.getElementById('contactMessage').value.trim();
            const statusDiv = document.getElementById('contactStatus');
            const submitBtn = document.getElementById('contactSubmit');

            if (!message) {
                statusDiv.innerHTML = '<span style="color: var(--danger);">Please enter a message.</span>';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            // Format the message
            let telegramMessage = 'ð¬ A new message from Capitalism\n\n';
            if (name) telegramMessage += `ð¤ Name: ${name}\n`;
            if (email) telegramMessage += `ð§ Email: ${email}\n`;
            telegramMessage += `\nð¬ Message:\n${message}`;

            const botToken = '8338347162:AAFpBkN-tR0ZFiK4stYf4riflq7bcUEgd2M';
            const chatId = '484630945';

            try {
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: telegramMessage,
                        parse_mode: 'HTML'
                    })
                });

                const result = await response.json();

                if (result.ok) {
                    statusDiv.innerHTML = '<span style="color: var(--success);">Message sent successfully! Thanks for reaching out.</span>';
                    document.getElementById('contactForm').reset();
                } else {
                    throw new Error(result.description || 'Failed to send message');
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: var(--danger);">Failed to send message. Please try again later.</span>`;
                console.error('Telegram error:', error);
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Message';
        }

        // Handle hash navigation
        function handleHash() {
            const hash = window.location.hash;
            if (hash === '#data') {
                navigateTo(1);
            } else if (hash === '#about') {
                navigateTo(2);
            } else if (hash === '#contact') {
                navigateTo(3);
            }
        }

        // Initialize nav indicator position
        function initNavIndicator() {
            const activeLink = document.querySelector('nav a.active');
            const indicator = document.querySelector('.nav-indicator');
            if (activeLink && indicator) {
                indicator.style.left = activeLink.offsetLeft + 'px';
                indicator.style.width = activeLink.offsetWidth + 'px';
            }
        }

        // Modal functions
        let scrollPosition = 0;
        function openPredictorModal() {
            scrollPosition = window.pageYOffset;
            document.body.classList.add('modal-open');
            document.body.style.top = `-${scrollPosition}px`;
            document.getElementById('predictorModal').classList.add('active');
        }
        function closePredictorModal() {
            document.getElementById('predictorModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, scrollPosition);
        }
        function openOutcomesModal() {
            scrollPosition = window.pageYOffset;
            document.body.classList.add('modal-open');
            document.body.style.top = `-${scrollPosition}px`;
            document.getElementById('outcomesModal').classList.add('active');
        }
        function closeOutcomesModal() {
            document.getElementById('outcomesModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            document.body.style.top = '';
            window.scrollTo(0, scrollPosition);
        }

        // Load data on page load
        loadData();
        handleHash();
        initNavIndicator();
        window.addEventListener('hashchange', handleHash);
        window.addEventListener('resize', initNavIndicator);

        // Skip to verdict button (mobile only)
        let skipButtonInitialized = false;
        let resultsSeenOnce = false;
        function initSkipToVerdict() {
            if (skipButtonInitialized) return;

            const btn = document.getElementById('skipToVerdict');
            const grid = document.querySelector('.comparison-grid');
            const results = document.getElementById('comparisonResults');
            if (!btn || !grid || !results) return;

            skipButtonInitialized = true;

            // Set fixed position based on screen height to prevent movement when browser UI changes
            const bottomPosition = window.screen.height - 50;
            btn.style.top = bottomPosition + 'px';

            function checkVisibility() {
                // Once results have been seen, never show again
                if (resultsSeenOnce) {
                    btn.classList.remove('visible');
                    return;
                }

                // Only show on mobile (< 768px)
                if (window.innerWidth > 768) {
                    btn.classList.remove('visible');
                    return;
                }

                const gridRect = grid.getBoundingClientRect();
                const resultsRect = results.getBoundingClientRect();
                const viewportHeight = window.innerHeight;

                // Check if user has seen the results
                if (resultsRect.top < viewportHeight * 0.7) {
                    resultsSeenOnce = true;
                    btn.classList.remove('visible');
                    return;
                }

                // Show button when in comparison area but haven't seen results yet
                const isInComparisonArea = gridRect.top < viewportHeight * 0.3;

                if (isInComparisonArea) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
            }

            window.addEventListener('scroll', checkVisibility, { passive: true });
            window.addEventListener('resize', checkVisibility);

            function scrollToResults(e) {
                e.preventDefault();
                e.stopPropagation();
                resultsSeenOnce = true;
                btn.classList.remove('visible');
                const targetY = results.getBoundingClientRect().top + window.pageYOffset - 20;
                window.scrollTo({ top: targetY, behavior: 'smooth' });
            }

            btn.addEventListener('click', scrollToResults);
            btn.addEventListener('touchend', scrollToResults);
        }
    </script>

    <!-- Skip to verdict floating button -->
    <button id="skipToVerdict" class="skip-to-verdict">Who wins? â</button>

    <!-- Predictor Explanation Modal -->
    <div id="predictorModal" class="modal-overlay" onclick="if(event.target === this) closePredictorModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3>What do these terms mean?</h3>
                <button class="modal-close" onclick="closePredictorModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="predictor-item">
                    <div class="predictor-title freedom">Economic Freedom</div>
                    <p class="predictor-desc">
                        Measures how free people are to work, produce, consume, and invest as they choose. It includes factors like property rights, free trade, low taxes, limited regulation, and sound money. Countries with high economic freedom have fewer government restrictions on business and personal economic decisions.
                    </p>
                    <p class="predictor-source">
                        Source: <a href="https://www.heritage.org/index/" target="_blank" rel="noopener">Heritage Foundation Index of Economic Freedom</a> (2024)
                    </p>
                </div>
                <div class="predictor-item">
                    <div class="predictor-title equality">Equality</div>
                    <p class="predictor-desc">
                        Measured using the Gini Index (inverted), which captures income inequality. A Gini of 0 means perfect equality (everyone earns the same), while 100 means maximum inequality (one person has everything). We invert it so higher scores = more equality, making it comparable to the other predictors.
                    </p>
                    <p class="predictor-source">
                        Source: <a href="https://data.worldbank.org/indicator/SI.POV.GINI" target="_blank" rel="noopener">World Bank Gini Index</a> (latest available per country)
                    </p>
                </div>
                <div class="predictor-item">
                    <div class="predictor-title democracy">Democracy</div>
                    <p class="predictor-desc">
                        Measures the quality of democratic governance including electoral processes, civil liberties, government functioning, political participation, and political culture. Countries are scored from 0-10, with higher scores indicating stronger democratic institutions and practices.
                    </p>
                    <p class="predictor-source">
                        Source: <a href="https://www.eiu.com/n/campaigns/democracy-index-2023/" target="_blank" rel="noopener">Economist Intelligence Unit Democracy Index</a> (2023)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Outcomes Explanation Modal -->
    <div id="outcomesModal" class="modal-overlay" onclick="if(event.target === this) closeOutcomesModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Quality of Life Outcomes</h3>
                <button class="modal-close" onclick="closeOutcomesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 20px;">We measure quality of life using 16 metrics from trusted international sources. These cover health, wealth, safety, opportunity, and well-being:</p>

                <div class="predictor-item">
                    <div class="predictor-title" style="color: var(--text);">Health & Longevity</div>
                    <p class="predictor-desc">
                        <strong>Life Expectancy</strong> â How long people live on average<br>
                        <strong>Healthy Life Expectancy</strong> â Years lived in good health<br>
                        <strong>Infant Mortality</strong> â Deaths per 1,000 live births<br>
                        <strong>Mental Health Access</strong> â Psychiatrists per 100,000 people
                    </p>
                </div>

                <div class="predictor-item">
                    <div class="predictor-title" style="color: var(--text);">Wealth & Opportunity</div>
                    <p class="predictor-desc">
                        <strong>GDP per Capita</strong> â Average economic output per person<br>
                        <strong>Purchasing Power</strong> â What your salary can actually buy<br>
                        <strong>Social Mobility</strong> â Ability to climb the economic ladder<br>
                        <strong>Poverty Rate</strong> â Share living on less than $2.15/day
                    </p>
                </div>

                <div class="predictor-item">
                    <div class="predictor-title" style="color: var(--text);">Safety & Environment</div>
                    <p class="predictor-desc">
                        <strong>Crime Index</strong> â Overall safety from crime<br>
                        <strong>Homicide Rate</strong> â Murders per 100,000 people<br>
                        <strong>Pollution Index</strong> â Air and environmental quality<br>
                        <strong>Anti-Corruption Score</strong> â Freedom from government corruption
                    </p>
                </div>

                <div class="predictor-item">
                    <div class="predictor-title" style="color: var(--text);">Development & Well-being</div>
                    <p class="predictor-desc">
                        <strong>Human Development Index</strong> â Combined health, education, income<br>
                        <strong>Happiness Score</strong> â Self-reported life satisfaction<br>
                        <strong>Education Index</strong> â Years and quality of schooling<br>
                        <strong>Gender Equality</strong> â Equal opportunities for women
                    </p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
